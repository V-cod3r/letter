<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Letter Jar</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Caveat:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #0a0205;
    --deep: #110308;
    --crimson: #8b0000;
    --crimson-mid: #a81020;
    --crimson-bright: #c8192a;
    --rose-pink: #e8384a;
    --rose-light: #f0606e;
    --gold: #c8a050;
    --gold-light: #e0c070;
    --cream: #f5e8e0;
    --paper: #fdf0ec;
    --ink: #1a0508;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background-color: var(--black);
    min-height: 100vh;
    width: 100%;
    font-family: 'Cormorant Garamond', serif;
    color: var(--cream);
    overflow-x: hidden;
    position: relative;
  }

  .bg-layer {
    position: fixed; inset: 0;
    background:
      radial-gradient(ellipse 80% 60% at 15% 10%, rgba(100,0,15,0.4) 0%, transparent 60%),
      radial-gradient(ellipse 60% 70% at 85% 90%, rgba(80,0,10,0.35) 0%, transparent 55%),
      radial-gradient(ellipse 40% 40% at 50% 50%, rgba(40,0,8,0.6) 0%, transparent 70%);
    pointer-events: none; z-index: 0;
  }

  .noise {
    position: fixed; inset: 0; opacity: 0.04;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 1;
  }

  /* ── ROSES ── */
  .rose-tl, .rose-br, .rose-tr { position: fixed; pointer-events: none; z-index: 2; }
  .rose-tl { top: -20px; left: -20px; width: 280px; transform: rotate(-15deg); opacity: 0.75; }
  .rose-tr { top: -10px; right: -10px; width: 220px; transform: rotate(20deg) scaleX(-1); opacity: 0.65; }
  .rose-br { bottom: -30px; right: -20px; width: 300px; transform: rotate(10deg); opacity: 0.75; }

  /* ── HEADER ── */
  header {
    position: relative; z-index: 10;
    width: 100%; padding: 24px 60px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid rgba(180,20,30,0.2);
    background: rgba(10,2,5,0.5); backdrop-filter: blur(10px);
  }
  .logo { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.4rem; color: var(--gold-light); letter-spacing: 0.05em; }
  nav { display: flex; gap: 36px; }
  nav a { font-family: 'Cormorant Garamond', serif; font-size: 0.88rem; letter-spacing: 0.15em; text-transform: uppercase; color: rgba(245,232,224,0.45); text-decoration: none; cursor: pointer; transition: color 0.3s; }
  nav a:hover { color: var(--rose-light); }

  /* ── HERO ── */
  .hero {
    position: relative; z-index: 5;
    display: grid;
    grid-template-columns: 1fr 460px 1fr;
    min-height: calc(100vh - 81px);
    align-items: center;
    padding: 60px 80px; gap: 50px;
  }

  /* LEFT */
  .hero-left { animation: fadeLeft 1.2s ease both; }
  @keyframes fadeLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }

  .eyebrow { font-family: 'Cormorant Garamond', serif; font-size: 0.75rem; letter-spacing: 0.32em; text-transform: uppercase; color: var(--crimson-bright); margin-bottom: 22px; display: flex; align-items: center; gap: 10px; }
  .eyebrow::before { content: ''; display: block; width: 28px; height: 1px; background: var(--crimson-bright); }

  .hero-title { font-family: 'Playfair Display', serif; font-size: clamp(2.8rem, 4vw, 5rem); font-weight: 700; line-height: 1.08; color: var(--cream); margin-bottom: 22px; }
  .hero-title em { font-style: italic; color: var(--rose-pink); display: block; }

  .hero-desc { font-size: 1.1rem; line-height: 1.85; color: rgba(245,232,224,0.55); max-width: 350px; margin-bottom: 36px; }

  .cta-group { display: flex; gap: 14px; flex-wrap: wrap; }

  .btn-primary { background: var(--crimson); border: 1px solid var(--crimson-mid); border-radius: 2px; padding: 13px 32px; font-family: 'Playfair Display', serif; font-style: italic; font-size: 1rem; color: var(--cream); cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(140,0,20,0.45), inset 0 1px 0 rgba(255,255,255,0.06); }
  .btn-primary:hover { background: var(--crimson-bright); transform: translateY(-2px); box-shadow: 0 8px 28px rgba(200,25,42,0.5); }

  .btn-ghost { background: none; border: 1px solid rgba(245,232,224,0.18); border-radius: 2px; padding: 13px 26px; font-family: 'Cormorant Garamond', serif; font-size: 1rem; color: rgba(245,232,224,0.55); cursor: pointer; transition: all 0.3s; }
  .btn-ghost:hover { border-color: rgba(245,232,224,0.45); color: var(--cream); }



  /* CENTER: JAR */
  .jar-col { display: flex; flex-direction: column; align-items: center; position: relative; animation: fadeUp 1.2s ease 0.25s both; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

  .jar-glow { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 340px; height: 340px; background: radial-gradient(ellipse, rgba(140,0,15,0.3) 0%, transparent 70%); pointer-events: none; filter: blur(24px); }

  .jar-scene { position: relative; width: 280px; height: 390px; flex-shrink: 0; }
  .jar-svg { position: absolute; inset: 0; width: 100%; height: 100%; filter: drop-shadow(0 30px 60px rgba(0,0,0,0.85)) drop-shadow(0 0 40px rgba(120,0,15,0.28)); }

  .jar-letters {
    position: absolute; bottom: 28px; left: 50%;
    transform: translateX(-50%);
    width: 170px;
    display: flex; flex-wrap: wrap; align-items: flex-end; justify-content: center;
    gap: 4px; padding: 6px; overflow: hidden; max-height: 275px;
  }

  /* ── LETTER SLIPS ── */
  .letter-slip {
    background: var(--paper);
    border-radius: 2px;
    padding: 5px 9px 5px 8px;
    font-family: 'Caveat', cursive;
    font-size: 11px;
    color: var(--ink);
    transform: rotate(calc(var(--r) * 1deg));
    box-shadow: 1px 3px 6px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.65);
    max-width: 105px;
    overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
    animation: dropIn 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
    opacity: 0;
    cursor: pointer;
    border-left: 3px solid var(--crimson);
    transition: filter 0.2s, opacity 0.4s;
    position: relative;
  }
  .letter-slip:hover { filter: brightness(1.08); }
  .letter-slip.is-read { opacity: 0.45; }

  @keyframes dropIn {
    from { opacity: 0; transform: rotate(calc(var(--r)*1deg)) translateY(-40px) scale(0.8); }
    to   { opacity: 1; transform: rotate(calc(var(--r)*1deg)) translateY(0) scale(1); }
  }
  .letter-slip.is-read.dropped { opacity: 0.45; }

  /* Unread dot on slip */
  .unread-dot {
    position: absolute;
    top: 3px; right: 3px;
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--crimson-bright);
    box-shadow: 0 0 4px rgba(200,25,42,0.9);
    animation: pulse-dot 1.8s ease-in-out infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.6; }
  }

  .empty-hint { font-style: italic; font-size: 0.78rem; color: rgba(180,80,80,0.32); text-align: center; position: absolute; bottom: 38px; left: 50%; transform: translateX(-50%); width: 140px; pointer-events: none; line-height: 1.6; }

  /* Badge */
  .letter-badge { position: absolute; top: 8px; right: -18px; background: var(--crimson); border: 2px solid rgba(200,25,42,0.4); color: var(--cream); font-family: 'Playfair Display', serif; font-size: 13px; font-weight: 700; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 14px rgba(0,0,0,0.5), 0 0 20px rgba(140,0,20,0.4); transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); z-index: 20; }
  .letter-badge.bump { transform: scale(1.5); }

  /* Envelope CTA */
  .env-cta { margin-top: 28px; display: flex; flex-direction: column; align-items: center; gap: 9px; cursor: pointer; background: none; border: none; color: rgba(245,232,224,0.4); font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.9rem; letter-spacing: 0.07em; transition: color 0.3s; }
  .env-cta:hover { color: var(--rose-light); }
  .env-cta:hover .env-icon { filter: drop-shadow(0 0 14px rgba(200,25,42,0.7)); transform: translateY(-3px); }
  .env-icon { width: 58px; height: 42px; transition: filter 0.3s, transform 0.3s; }

  /* ── READ JAR (second smaller jar below) ── */
  .read-jar-section {
    margin-top: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: 100%;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.5s ease, transform 0.5s ease;
    pointer-events: none;
  }
  .read-jar-section.visible { opacity: 1; transform: translateY(0); pointer-events: all; }

  .read-jar-label {
    font-family: 'Cormorant Garamond', serif;
    font-style: italic;
    font-size: 0.8rem;
    letter-spacing: 0.12em;
    color: rgba(245,232,224,0.3);
    display: flex; align-items: center; gap: 8px;
    text-transform: uppercase; font-size: 0.72rem;
  }
  .read-jar-label::before, .read-jar-label::after { content: ''; flex: 1; height: 1px; background: rgba(180,20,30,0.2); }

  .read-jar-scene {
    position: relative;
    width: 140px; height: 200px;
    cursor: pointer;
  }
  .read-jar-scene:hover .rj-svg { filter: drop-shadow(0 10px 25px rgba(0,0,0,0.7)) drop-shadow(0 0 20px rgba(120,0,15,0.3)); }
  .rj-svg { width: 100%; height: 100%; transition: filter 0.3s; filter: drop-shadow(0 8px 20px rgba(0,0,0,0.7)) drop-shadow(0 0 15px rgba(80,0,10,0.2)); }

  .rj-letters {
    position: absolute;
    bottom: 14px; left: 50%;
    transform: translateX(-50%);
    width: 84px;
    display: flex; flex-wrap: wrap; align-items: flex-end; justify-content: center;
    gap: 3px; padding: 3px;
    overflow: hidden; max-height: 135px;
  }
  .rj-slip {
    background: var(--paper);
    border-radius: 2px; padding: 3px 6px;
    font-family: 'Caveat', cursive; font-size: 9px; color: var(--ink);
    transform: rotate(calc(var(--r)*1deg));
    box-shadow: 1px 2px 4px rgba(0,0,0,0.4);
    max-width: 60px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
    border-left: 2px solid var(--crimson);
    opacity: 0.75;
    animation: dropInSmall 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards;
  }
  @keyframes dropInSmall {
    from { opacity: 0; transform: rotate(calc(var(--r)*1deg)) translateY(-20px); }
    to   { opacity: 0.75; transform: rotate(calc(var(--r)*1deg)) translateY(0); }
  }

  .read-badge {
    position: absolute; top: 4px; right: -12px;
    background: rgba(60,60,60,0.9);
    border: 1px solid rgba(180,180,180,0.2);
    color: rgba(245,232,224,0.6);
    font-family: 'Playfair Display', serif; font-size: 11px; font-weight: 700;
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  /* RIGHT */
  .hero-right { display: flex; flex-direction: column; gap: 18px; animation: fadeRight 1.2s ease 0.15s both; }
  @keyframes fadeRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }

  /* Tabs */
  .panel-tabs { display: flex; gap: 0; border-bottom: 1px solid rgba(180,20,30,0.2); margin-bottom: 4px; }
  .panel-tab {
    font-family: 'Cormorant Garamond', serif;
    font-style: italic; font-size: 0.95rem;
    color: rgba(245,232,224,0.35);
    padding: 6px 18px 10px 0;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s;
    position: relative; bottom: -1px;
    background: none; border-top: none; border-left: none; border-right: none;
  }
  .panel-tab.active { color: var(--gold-light); border-bottom: 2px solid var(--crimson); }
  .panel-tab:hover:not(.active) { color: rgba(245,232,224,0.65); }

  .tab-badge {
    display: inline-flex; align-items: center; justify-content: center;
    background: var(--crimson); color: var(--cream);
    font-size: 0.65rem; font-style: normal;
    width: 16px; height: 16px; border-radius: 50%;
    margin-left: 5px; vertical-align: middle;
    font-family: 'Playfair Display', serif; font-weight: 700;
    transition: transform 0.3s;
  }
  .tab-badge.hidden { display: none; }

  .recent-title { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.15rem; color: var(--gold-light); display: flex; align-items: center; gap: 12px; }
  .recent-title::after { content: ''; flex: 1; height: 1px; background: rgba(200,160,80,0.2); min-width: 16px; }

  .tab-pane { display: none; flex-direction: column; gap: 11px; }
  .tab-pane.active { display: flex; }

  .recent-card { background: rgba(30,5,10,0.65); border: 1px solid rgba(140,0,20,0.18); border-radius: 3px; padding: 15px 18px; backdrop-filter: blur(6px); cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
  .recent-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--env-color, var(--crimson)); }
  .recent-card:hover { border-color: rgba(200,25,42,0.35); background: rgba(50,5,15,0.75); transform: translateX(4px); }
  .recent-card.card-read { opacity: 0.55; }
  .recent-from { font-family: 'Caveat', cursive; font-size: 0.8rem; color: var(--crimson-bright); margin-bottom: 5px; letter-spacing: 0.04em; display: flex; align-items: center; gap: 8px; }
  .recent-preview { font-family: 'Caveat', cursive; font-size: 1rem; color: rgba(245,232,224,0.65); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Unread dot on card */
  .card-unread-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--crimson-bright); box-shadow: 0 0 5px rgba(200,25,42,0.8); flex-shrink: 0; animation: pulse-dot 1.8s ease-in-out infinite; }

  .no-letters-hint { font-style: italic; font-size: 1rem; color: rgba(245,232,224,0.22); line-height: 1.75; }

  /* ── COLOR SWATCHES ── */
  .color-picker-row {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 24px;
  }
  .color-picker-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.76rem; letter-spacing: 0.22em;
    text-transform: uppercase; color: rgba(245,232,224,0.38);
    margin-right: 4px;
  }
  .swatch {
    width: 24px; height: 24px; border-radius: 50%;
    cursor: pointer; border: 2px solid transparent;
    transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
    position: relative;
    flex-shrink: 0;
  }
  .swatch:hover { transform: scale(1.15); }
  .swatch.selected {
    border-color: rgba(245,232,224,0.7);
    box-shadow: 0 0 0 2px rgba(200,25,42,0.5);
    transform: scale(1.15);
  }

  /* Live envelope preview in modal */
  .env-preview {
    position: absolute; top: 50px; right: 52px;
    width: 50px; height: 36px;
    transition: all 0.3s;
  }

  /* ── MODAL ── */
  .overlay { position: fixed; inset: 0; background: rgba(5,0,2,0.88); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.4s; padding: 20px; }
  .overlay.open { opacity: 1; pointer-events: all; }

  .modal { background: #0f0204; border: 1px solid rgba(180,20,30,0.28); border-radius: 4px; padding: 50px 52px; max-width: 520px; width: 100%; color: var(--cream); box-shadow: 0 40px 100px rgba(0,0,0,0.85), 0 0 60px rgba(120,0,20,0.18); transform: scale(0.88) translateY(24px); transition: transform 0.45s cubic-bezier(0.34,1.56,0.64,1); position: relative; background-image: radial-gradient(ellipse at 100% 0%, rgba(100,0,15,0.16) 0%, transparent 60%); }
  .overlay.open .modal { transform: scale(1) translateY(0); }

  .modal-rose { position: absolute; top: -12px; right: -12px; width: 100px; opacity: 0.45; transform: rotate(25deg); pointer-events: none; }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 1.9rem; font-weight: 400; font-style: italic; color: var(--cream); margin-bottom: 6px; }
  .modal-sub { font-style: italic; font-size: 1rem; color: rgba(245,232,224,0.38); margin-bottom: 10px; }
  .divider { width: 36px; height: 1px; background: var(--crimson); margin: 16px 0 28px; }

  label { display: block; font-size: 0.76rem; letter-spacing: 0.22em; text-transform: uppercase; color: rgba(245,232,224,0.38); margin-bottom: 8px; }

  input[type="text"], textarea { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(180,20,30,0.22); border-radius: 2px; padding: 12px 16px; font-family: 'Caveat', cursive; font-size: 1.15rem; color: var(--cream); outline: none; resize: none; transition: border-color 0.2s, box-shadow 0.2s; margin-bottom: 20px; }
  input[type="text"]::placeholder, textarea::placeholder { color: rgba(245,232,224,0.18); }
  input[type="text"]:focus, textarea:focus { border-color: rgba(200,25,42,0.55); box-shadow: 0 0 0 3px rgba(200,25,42,0.1); }



  .modal-actions { display: flex; gap: 14px; justify-content: flex-end; margin-top: 8px; }
  .btn-cancel-modal { background: none; border: 1px solid rgba(245,232,224,0.14); border-radius: 2px; padding: 11px 22px; font-family: 'Cormorant Garamond', serif; font-size: 1rem; color: rgba(245,232,224,0.38); cursor: pointer; transition: all 0.2s; }
  .btn-cancel-modal:hover { border-color: rgba(245,232,224,0.35); color: var(--cream); }
  .btn-submit-modal { background: var(--crimson); border: 1px solid var(--crimson-mid); border-radius: 2px; padding: 11px 30px; font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.05rem; color: var(--cream); cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(140,0,20,0.45); }
  .btn-submit-modal:hover { background: var(--crimson-bright); transform: translateY(-2px); box-shadow: 0 8px 28px rgba(200,25,42,0.5); }

  /* ── READ MODAL ── */
  .read-overlay { position: fixed; inset: 0; background: rgba(5,0,2,0.92); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; padding: 20px; }
  .read-overlay.open { opacity: 1; pointer-events: all; }

  .read-modal { background: #0f0204; border: 1px solid rgba(180,20,30,0.22); border-radius: 4px; padding: 48px 54px; max-width: 460px; width: 100%; color: var(--cream); box-shadow: 0 40px 80px rgba(0,0,0,0.85), 0 0 40px rgba(120,0,20,0.18); transform: scale(0.9) rotate(-1.5deg); transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1); position: relative; }
  .read-overlay.open .read-modal { transform: scale(1) rotate(0deg); }

  .read-close { position: absolute; top: 14px; right: 18px; background: none; border: none; font-size: 1.6rem; color: rgba(245,232,224,0.28); cursor: pointer; transition: color 0.2s; }
  .read-close:hover { color: var(--rose-pink); }

  /* Wax seal on read modal */
  .read-wax { position: absolute; bottom: 20px; right: 24px; width: 34px; height: 34px; }

  .read-from { font-style: italic; font-size: 0.85rem; letter-spacing: 0.1em; color: var(--crimson-bright); margin-bottom: 16px; }
  .read-divider { width: 28px; height: 1px; background: rgba(180,20,30,0.4); margin-bottom: 20px; }
  .read-body { font-family: 'Caveat', cursive; font-size: 1.4rem; line-height: 1.85; color: rgba(245,232,224,0.85); white-space: pre-wrap; min-height: 80px; }

  /* Envelope color stripe on read modal */
  .read-env-stripe { height: 3px; border-radius: 2px; margin-bottom: 24px; width: 100%; }

  /* Read jar list modal */
  .rj-modal { background: #0f0204; border: 1px solid rgba(180,20,30,0.22); border-radius: 4px; padding: 40px 44px; max-width: 440px; width: 100%; color: var(--cream); box-shadow: 0 30px 70px rgba(0,0,0,0.85); transform: scale(0.88) translateY(20px); transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1); max-height: 80vh; overflow-y: auto; position: relative; }
  .read-overlay.open .rj-modal { transform: scale(1) translateY(0); }
  .rj-modal-title { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.5rem; color: var(--cream); margin-bottom: 6px; }
  .rj-modal-sub { font-style: italic; font-size: 0.9rem; color: rgba(245,232,224,0.35); margin-bottom: 24px; }
  .rj-list-item { border: 1px solid rgba(140,0,20,0.15); border-radius: 2px; padding: 14px 16px; margin-bottom: 10px; cursor: pointer; transition: all 0.25s; background: rgba(20,5,10,0.5); position: relative; overflow: hidden; }
  .rj-list-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--env-color, var(--crimson)); }
  .rj-list-item:hover { background: rgba(40,5,15,0.7); border-color: rgba(200,25,42,0.3); transform: translateX(3px); }
  .rj-item-from { font-family: 'Caveat', cursive; font-size: 0.8rem; color: var(--crimson-bright); margin-bottom: 4px; }
  .rj-item-preview { font-family: 'Caveat', cursive; font-size: 1rem; color: rgba(245,232,224,0.6); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .rj-empty { font-style: italic; color: rgba(245,232,224,0.25); font-size: 1rem; margin-top: 10px; }

  /* TOAST */
  .toast { position: fixed; bottom: 36px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--crimson); color: var(--cream); padding: 12px 28px; border-radius: 2px; font-style: italic; font-size: 1.05rem; box-shadow: 0 6px 30px rgba(0,0,0,0.55), 0 0 20px rgba(140,0,20,0.4); opacity: 0; transition: all 0.4s cubic-bezier(0.34,1.56,0.64,1); z-index: 300; pointer-events: none; border: 1px solid rgba(200,25,42,0.35); }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* FOOTER */
  footer { position: relative; z-index: 10; text-align: center; padding: 18px; border-top: 1px solid rgba(180,20,30,0.1); font-style: italic; font-size: 0.82rem; color: rgba(245,232,224,0.18); }

  /* Loading skeleton */
  .loading-hint { font-style: italic; font-size: 0.8rem; color: rgba(180,80,80,0.28); text-align: center; padding: 10px; }

  /* Scrollbar */
  .rj-modal::-webkit-scrollbar { width: 4px; }
  .rj-modal::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
  .rj-modal::-webkit-scrollbar-thumb { background: rgba(200,25,42,0.3); border-radius: 2px; }
</style>
</head>
<body>

<div class="bg-layer"></div>
<div class="noise"></div>

<!-- ROSE TL -->
<svg class="rose-tl" viewBox="0 0 280 320" xmlns="http://www.w3.org/2000/svg">
  <path d="M140,310 Q120,240 110,180 Q100,130 130,90" stroke="#1a4020" stroke-width="4" fill="none" stroke-linecap="round"/>
  <path d="M118,210 Q80,190 70,160 Q100,165 118,210Z" fill="#1a3818" opacity="0.8"/>
  <path d="M112,170 Q150,150 155,120 Q125,130 112,170Z" fill="#1a3818" opacity="0.7"/>
  <g transform="translate(130,85)">
    <ellipse cx="0" cy="0" rx="33" ry="29" fill="#6b0010"/><ellipse cx="0" cy="-2" rx="27" ry="23" fill="#8b0018"/>
    <path d="M0,-21 Q16,-11 19,6 Q11,19 0,21 Q-11,19 -19,6 Q-16,-11 0,-21Z" fill="#a81020"/>
    <path d="M0,-14 Q10,-6 12,5 Q7,14 0,16 Q-7,14 -12,5 Q-10,-6 0,-14Z" fill="#c8192a"/>
    <path d="M0,-9 Q7,-4 9,4 Q4,10 0,11 Q-4,10 -9,4 Q-7,-4 0,-9Z" fill="#e02030"/>
    <path d="M0,-23 Q-21,-29 -31,-19 Q-23,-8 0,-15Z" fill="#8b0018" opacity="0.9"/>
    <path d="M0,-23 Q21,-29 31,-19 Q23,-8 0,-15Z" fill="#8b0018" opacity="0.9"/>
    <path d="M-27,6 Q-37,-8 -31,-21 Q-19,-13 -19,6Z" fill="#7a0015" opacity="0.8"/>
    <path d="M27,6 Q37,-8 31,-21 Q19,-13 19,6Z" fill="#7a0015" opacity="0.8"/>
    <path d="M-21,19 Q-35,11 -33,-5 Q-19,0 -15,19Z" fill="#6b0010" opacity="0.85"/>
    <path d="M21,19 Q35,11 33,-5 Q19,0 15,19Z" fill="#6b0010" opacity="0.85"/>
    <ellipse cx="0" cy="23" rx="17" ry="7" fill="#5a000c" opacity="0.6"/>
  </g>
  <g transform="translate(95,145)">
    <ellipse cx="0" cy="0" rx="20" ry="17" fill="#5a000c"/><ellipse cx="0" cy="-1" rx="15" ry="13" fill="#7a0015"/>
    <path d="M0,-12 Q9,-5 10,4 Q5,11 0,12 Q-5,11 -10,4 Q-9,-5 0,-12Z" fill="#a01020"/>
    <path d="M0,-7 Q5,-2 6,3 Q3,7 0,8 Q-3,7 -6,3 Q-5,-2 0,-7Z" fill="#c8192a"/>
    <path d="M0,-13 Q-12,-18 -18,-10 Q-13,-4 0,-8Z" fill="#7a0015"/>
    <path d="M0,-13 Q12,-18 18,-10 Q13,-4 0,-8Z" fill="#7a0015"/>
    <path d="M-15,5 Q-22,-5 -18,-14 Q-10,-7 -10,5Z" fill="#6b0010" opacity="0.8"/>
    <path d="M15,5 Q22,-5 18,-14 Q10,-7 10,5Z" fill="#6b0010" opacity="0.8"/>
  </g>
</svg>

<!-- ROSE TR -->
<svg class="rose-tr" viewBox="0 0 220 260" xmlns="http://www.w3.org/2000/svg">
  <path d="M80,250 Q90,190 100,140 Q108,100 90,65" stroke="#1a4020" stroke-width="3.5" fill="none" stroke-linecap="round"/>
  <path d="M97,185 Q130,165 135,140 Q108,148 97,185Z" fill="#1a3818" opacity="0.8"/>
  <path d="M102,148 Q70,128 66,100 Q92,112 102,148Z" fill="#1a3818" opacity="0.7"/>
  <g transform="translate(90,62)">
    <ellipse cx="0" cy="0" rx="28" ry="24" fill="#6b0010"/><ellipse cx="0" cy="-1" rx="22" ry="18" fill="#8b0018"/>
    <path d="M0,-17 Q12,-8 14,4 Q8,15 0,16 Q-8,15 -14,4 Q-12,-8 0,-17Z" fill="#a81020"/>
    <path d="M0,-11 Q8,-4 9,4 Q5,11 0,12 Q-5,11 -9,4 Q-8,-4 0,-11Z" fill="#c8192a"/>
    <path d="M0,-18 Q-17,-24 -25,-14 Q-18,-5 0,-11Z" fill="#8b0018" opacity="0.9"/>
    <path d="M0,-18 Q17,-24 25,-14 Q18,-5 0,-11Z" fill="#8b0018" opacity="0.9"/>
    <path d="M-22,4 Q-30,-7 -25,-18 Q-14,-10 -14,4Z" fill="#7a0015" opacity="0.85"/>
    <path d="M22,4 Q30,-7 25,-18 Q14,-10 14,4Z" fill="#7a0015" opacity="0.85"/>
    <path d="M-16,16 Q-28,8 -26,-4 Q-14,0 -11,16Z" fill="#6b0010" opacity="0.8"/>
    <path d="M16,16 Q28,8 26,-4 Q14,0 11,16Z" fill="#6b0010" opacity="0.8"/>
  </g>
</svg>

<!-- ROSE BR -->
<svg class="rose-br" viewBox="0 0 300 340" xmlns="http://www.w3.org/2000/svg">
  <path d="M150,30 Q140,100 130,160 Q118,210 140,260" stroke="#1a4020" stroke-width="4" fill="none" stroke-linecap="round"/>
  <path d="M135,120 Q100,100 95,72 Q122,82 135,120Z" fill="#1a3818" opacity="0.8"/>
  <path d="M128,165 Q165,148 168,118 Q140,128 128,165Z" fill="#1a3818" opacity="0.7"/>
  <path d="M143,230 Q108,215 102,188 Q130,192 143,230Z" fill="#1a3818" opacity="0.65"/>
  <g transform="translate(150,262)">
    <ellipse cx="0" cy="0" rx="36" ry="32" fill="#6b0010"/><ellipse cx="0" cy="-2" rx="29" ry="25" fill="#8b0018"/>
    <path d="M0,-22 Q17,-12 20,6 Q12,20 0,22 Q-12,20 -20,6 Q-17,-12 0,-22Z" fill="#a81020"/>
    <path d="M0,-14 Q11,-6 13,5 Q7,14 0,16 Q-7,14 -13,5 Q-11,-6 0,-14Z" fill="#c8192a"/>
    <path d="M0,-9 Q7,-4 9,4 Q4,10 0,11 Q-4,10 -9,4 Q-7,-4 0,-9Z" fill="#e02030"/>
    <path d="M0,-24 Q-22,-31 -33,-19 Q-24,-9 0,-16Z" fill="#8b0018" opacity="0.9"/>
    <path d="M0,-24 Q22,-31 33,-19 Q24,-9 0,-16Z" fill="#8b0018" opacity="0.9"/>
    <path d="M-29,6 Q-40,-8 -34,-22 Q-20,-13 -20,6Z" fill="#7a0015" opacity="0.85"/>
    <path d="M29,6 Q40,-8 34,-22 Q20,-13 20,6Z" fill="#7a0015" opacity="0.85"/>
    <path d="M-24,22 Q-38,12 -36,-4 Q-20,0 -16,22Z" fill="#6b0010" opacity="0.85"/>
    <path d="M24,22 Q38,12 36,-4 Q20,0 16,22Z" fill="#6b0010" opacity="0.85"/>
    <ellipse cx="0" cy="26" rx="18" ry="7" fill="#5a000c" opacity="0.6"/>
  </g>
  <g transform="translate(112,80)">
    <ellipse cx="0" cy="0" rx="22" ry="19" fill="#5a000c"/><ellipse cx="0" cy="-1" rx="17" ry="14" fill="#7a0015"/>
    <path d="M0,-13 Q10,-6 11,4 Q6,12 0,13 Q-6,12 -11,4 Q-10,-6 0,-13Z" fill="#a01020"/>
    <path d="M0,-8 Q6,-2 7,3 Q3,8 0,9 Q-3,8 -7,3 Q-6,-2 0,-8Z" fill="#c8192a"/>
    <path d="M0,-14 Q-13,-19 -20,-11 Q-14,-4 0,-9Z" fill="#7a0015"/>
    <path d="M0,-14 Q13,-19 20,-11 Q14,-4 0,-9Z" fill="#7a0015"/>
    <path d="M-16,5 Q-24,-6 -20,-16 Q-11,-8 -11,5Z" fill="#6b0010" opacity="0.8"/>
    <path d="M16,5 Q24,-6 20,-16 Q11,-8 11,5Z" fill="#6b0010" opacity="0.8"/>
  </g>
</svg>

<!-- HEADER -->
<header>
  <div class="logo">The Letter Jar ✦</div>
  <nav>
    <a>About</a>
    <a onclick="openModal()">Write a Letter</a>
    <a>Archive</a>
  </nav>
</header>

<!-- HERO -->
<main class="hero">

  <!-- LEFT -->
  <div class="hero-left">
    <div class="eyebrow">A collection of words</div>
    <h1 class="hero-title">
      Leave a note,<br>
      <em>fill the jar</em>
    </h1>
    <p class="hero-desc">Every letter carries a piece of you. Write something tender, something true — fold it up and drop it in for someone to find.</p>
    <div class="cta-group">
      <button class="btn-primary" onclick="openModal()">Write your letter</button>
      <button class="btn-ghost" onclick="scrollJar()">Read the jar</button>
    </div>

  </div>

  <!-- JAR -->
  <div class="jar-col">
    <div class="jar-glow"></div>
    <div class="jar-scene">
      <div class="letter-badge" id="letterBadge">0</div>
      <svg class="jar-svg" viewBox="0 0 280 390" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="jarFill" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"  stop-color="#220008" stop-opacity="0.75"/>
            <stop offset="22%" stop-color="#3a0010" stop-opacity="0.48"/>
            <stop offset="55%" stop-color="#180005" stop-opacity="0.58"/>
            <stop offset="100%" stop-color="#0e0003" stop-opacity="0.82"/>
          </linearGradient>
          <linearGradient id="lidRed" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#c8192a"/>
            <stop offset="42%" stop-color="#8b0018"/>
            <stop offset="100%" stop-color="#5a0010"/>
          </linearGradient>
          <linearGradient id="lidBand" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#a01020"/>
            <stop offset="100%" stop-color="#6b000e"/>
          </linearGradient>
          <radialGradient id="innerGlow" cx="50%" cy="50%">
            <stop offset="0%" stop-color="rgba(200,25,42,0.07)"/>
            <stop offset="100%" stop-color="transparent"/>
          </radialGradient>
          <linearGradient id="jarFillSmall" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"  stop-color="#1a0006" stop-opacity="0.75"/>
            <stop offset="22%" stop-color="#2d000b" stop-opacity="0.48"/>
            <stop offset="55%" stop-color="#150004" stop-opacity="0.58"/>
            <stop offset="100%" stop-color="#0c0003" stop-opacity="0.82"/>
          </linearGradient>
          <linearGradient id="lidRedSmall" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#8b0018"/>
            <stop offset="100%" stop-color="#3a000a"/>
          </linearGradient>
        </defs>
        <path d="M62,104 Q56,112 50,130 L38,338 Q36,364 140,367 Q244,364 242,338 L230,130 Q224,112 218,104 Z"
          fill="url(#jarFill)" stroke="rgba(200,25,42,0.28)" stroke-width="1.5"/>
        <path d="M62,104 Q56,112 50,130 L38,338 Q36,364 140,367 Q244,364 242,338 L230,130 Q224,112 218,104 Z"
          fill="url(#innerGlow)"/>
        <path d="M68,116 Q64,125 61,144 L54,308" stroke="rgba(255,120,120,0.14)" stroke-width="14" stroke-linecap="round" fill="none"/>
        <path d="M80,105 L96,105" stroke="rgba(255,180,180,0.22)" stroke-width="3" stroke-linecap="round"/>
        <ellipse cx="140" cy="104" rx="78" ry="8" fill="rgba(200,25,42,0.08)" stroke="rgba(200,25,42,0.18)" stroke-width="1"/>
        <ellipse cx="140" cy="358" rx="100" ry="9" fill="rgba(100,0,15,0.22)"/>
        <rect x="60" y="86" width="160" height="22" rx="5" fill="url(#lidBand)" stroke="rgba(200,50,60,0.28)" stroke-width="1"/>
        <rect x="70" y="64" width="140" height="26" rx="9" fill="url(#lidRed)" stroke="rgba(200,50,60,0.38)" stroke-width="1"/>
        <rect x="86" y="69" width="64" height="7" rx="3.5" fill="rgba(255,150,150,0.2)"/>
        <rect x="90" y="200" width="100" height="72" rx="3"
          fill="none" stroke="rgba(200,25,42,0.18)" stroke-width="1" stroke-dasharray="3,3"/>
        <text x="140" y="228" text-anchor="middle" font-family="Playfair Display, serif" font-style="italic" font-size="10" fill="rgba(200,60,70,0.48)">Letters</text>
        <text x="140" y="244" text-anchor="middle" font-family="Cormorant Garamond, serif" font-size="8" fill="rgba(200,60,70,0.38)">— with love —</text>
        <text x="140" y="260" text-anchor="middle" font-size="9" fill="rgba(200,60,70,0.32)">✦</text>
        <ellipse cx="140" cy="363" rx="98" ry="5" fill="rgba(0,0,0,0.45)"/>
      </svg>

      <div class="jar-letters" id="jarLetters">
        <div class="empty-hint" id="emptyHint">no letters yet…<br>be the first</div>
      </div>
    </div>

    <!-- Envelope CTA -->
    <button class="env-cta" onclick="openModal()">
      <svg class="env-icon" id="envCTAIcon" viewBox="0 0 60 44" xmlns="http://www.w3.org/2000/svg">
        <rect x="1" y="5" width="58" height="36" rx="3" fill="rgba(139,0,24,0.14)" stroke="rgba(200,25,42,0.58)" stroke-width="1.5"/>
        <path d="M1,5 L30,26 L59,5" fill="none" stroke="rgba(200,25,42,0.7)" stroke-width="1.5" stroke-linejoin="round"/>
        <path d="M1,41 L22,22 M59,41 L38,22" stroke="rgba(200,25,42,0.32)" stroke-width="1"/>
        <circle cx="30" cy="25" r="4.5" fill="rgba(139,0,24,0.8)" stroke="rgba(200,25,42,0.45)" stroke-width="1"/>
        <text x="30" y="28.5" text-anchor="middle" font-size="5" fill="rgba(245,232,224,0.9)">✦</text>
      </svg>
      drop a letter in
    </button>

    <!-- READ JAR (letters you've read) -->
    <div class="read-jar-section" id="readJarSection">
      <div class="read-jar-label">Your read letters</div>
      <div class="read-jar-scene" onclick="openReadJarModal()" title="View your read letters">
        <div class="read-badge" id="readBadge">0</div>
        <svg class="rj-svg" viewBox="0 0 140 200" xmlns="http://www.w3.org/2000/svg">
          <path d="M30,55 Q27,60 24,70 L18,172 Q17,184 70,185 Q123,184 122,172 L116,70 Q113,60 110,55 Z"
            fill="url(#jarFillSmall)" stroke="rgba(150,20,30,0.2)" stroke-width="1"/>
          <path d="M33,62 Q31,66 29,74 L26,158" stroke="rgba(255,100,100,0.1)" stroke-width="7" stroke-linecap="round" fill="none"/>
          <ellipse cx="70" cy="55" rx="40" ry="4.5" fill="rgba(180,20,30,0.06)" stroke="rgba(180,20,30,0.14)" stroke-width="1"/>
          <ellipse cx="70" cy="180" rx="51" ry="5" fill="rgba(80,0,10,0.18)"/>
          <rect x="29" y="46" width="82" height="12" rx="3" fill="url(#lidRedSmall)" stroke="rgba(180,40,50,0.2)" stroke-width="0.8"/>
          <rect x="34" y="36" width="72" height="13" rx="5" fill="url(#lidRedSmall)" stroke="rgba(180,40,50,0.25)" stroke-width="0.8" opacity="0.85"/>
          <rect x="41" y="39" width="32" height="4" rx="2" fill="rgba(255,120,120,0.16)"/>
          <text x="70" y="118" text-anchor="middle" font-family="Playfair Display, serif" font-style="italic" font-size="7" fill="rgba(180,50,60,0.4)">Read</text>
          <text x="70" y="130" text-anchor="middle" font-size="6" fill="rgba(180,50,60,0.3)">✦</text>
          <ellipse cx="70" cy="182" rx="50" ry="3" fill="rgba(0,0,0,0.35)"/>
        </svg>
        <div class="rj-letters" id="rjLetters"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: PANEL -->
  <div class="hero-right">
    <div class="recent-title">Letters</div>

    <!-- Tabs -->
    <div class="panel-tabs">
      <button class="panel-tab active" onclick="switchTab('all')" id="tabAll">
        All <span class="tab-badge hidden" id="unreadBadge">0</span>
      </button>
      <button class="panel-tab" onclick="switchTab('unread')" id="tabUnread">
        Unread <span class="tab-badge hidden" id="unreadBadge2">0</span>
      </button>
    </div>

    <!-- All tab -->
    <div class="tab-pane active" id="paneAll">
      <p class="no-letters-hint" id="noLettersHint">The jar awaits its first<br>folded secret…</p>
    </div>

    <!-- Unread tab -->
    <div class="tab-pane" id="paneUnread">
      <p class="no-letters-hint" id="noUnreadHint" style="display:none">You've read everything<br>in the jar ✦</p>
    </div>
  </div>

</main>

<footer>The Letter Jar &nbsp;✦&nbsp; Every word belongs here</footer>

<!-- WRITE MODAL -->
<div class="overlay" id="overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <svg class="modal-rose" viewBox="0 0 110 130" xmlns="http://www.w3.org/2000/svg">
      <path d="M55,120 Q48,85 44,60 Q40,40 52,20" stroke="#1a3818" stroke-width="3" fill="none" stroke-linecap="round"/>
      <path d="M46,75 Q28,63 25,44 Q44,50 46,75Z" fill="#1a3818" opacity="0.7"/>
      <g transform="translate(52,18)">
        <ellipse cx="0" cy="0" rx="22" ry="19" fill="#6b0010"/><ellipse cx="0" cy="-1" rx="17" ry="14" fill="#8b0018"/>
        <path d="M0,-13 Q10,-6 11,4 Q6,12 0,13 Q-6,12 -11,4 Q-10,-6 0,-13Z" fill="#a81020"/>
        <path d="M0,-8 Q6,-3 7,4 Q4,10 0,11 Q-4,10 -7,4 Q-6,-3 0,-8Z" fill="#c8192a"/>
        <path d="M0,-14 Q-13,-19 -20,-11 Q-14,-4 0,-9Z" fill="#8b0018"/>
        <path d="M0,-14 Q13,-19 20,-11 Q14,-4 0,-9Z" fill="#8b0018"/>
        <path d="M-16,5 Q-24,-6 -20,-16 Q-11,-8 -11,5Z" fill="#7a0015" opacity="0.85"/>
        <path d="M16,5 Q24,-6 20,-16 Q11,-8 11,5Z" fill="#7a0015" opacity="0.85"/>
      </g>
    </svg>

    <div class="modal-title">Write your letter</div>
    <p class="modal-sub">A note, a memory, a secret — fold it and let it rest.</p>
    <div class="divider"></div>

    <!-- COLOR PICKER -->
    <div class="color-picker-row">
      <span class="color-picker-label">Envelope</span>
      <div class="swatch selected" data-color="#c8192a" data-name="Crimson" style="background:#c8192a" onclick="selectColor(this)" title="Crimson"></div>
      <div class="swatch" data-color="#c8a050" data-name="Gold" style="background:#c8a050" onclick="selectColor(this)" title="Antique Gold"></div>
      <div class="swatch" data-color="#3a6bc8" data-name="Midnight" style="background:#3a6bc8" onclick="selectColor(this)" title="Midnight Blue"></div>
      <div class="swatch" data-color="#3a8050" data-name="Forest" style="background:#3a8050" onclick="selectColor(this)" title="Forest Green"></div>
      <div class="swatch" data-color="#9a2a8a" data-name="Plum" style="background:#9a2a8a" onclick="selectColor(this)" title="Plum"></div>
      <div class="swatch" data-color="#a08060" data-name="Bone" style="background:#a08060" onclick="selectColor(this)" title="Aged Bone"></div>
    </div>

    <label for="fromField">From</label>
    <input type="text" id="fromField" placeholder="Your name, or stay a mystery…" maxlength="40"/>

    <label for="letterBody">Your letter</label>
    <textarea id="letterBody" rows="5" placeholder="Write whatever your heart holds…"></textarea>

    <div class="modal-actions">
      <button class="btn-cancel-modal" onclick="closeModal()">Cancel</button>
      <button class="btn-submit-modal" onclick="submitLetter()">Drop it in ✦</button>
    </div>
  </div>
</div>

<!-- READ LETTER MODAL -->
<div class="read-overlay" id="readOverlay" onclick="handleReadClick(event)">
  <div class="read-modal" id="readModal">
    <button class="read-close" onclick="closeRead()">×</button>
    <div class="read-env-stripe" id="readEnvStripe"></div>
    <div class="read-from" id="readFrom"></div>
    <div class="read-divider"></div>
    <div class="read-body" id="readBody"></div>
    <svg class="read-wax" viewBox="0 0 34 34" xmlns="http://www.w3.org/2000/svg" id="readWax">
      <circle cx="17" cy="17" r="15" fill="rgba(100,0,15,0.7)"/>
      <circle cx="17" cy="17" r="12" fill="none" stroke="rgba(180,50,60,0.35)" stroke-width="0.8"/>
      <text x="17" y="21" text-anchor="middle" font-size="10" fill="rgba(245,200,180,0.7)">✦</text>
    </svg>
  </div>
</div>

<!-- READ JAR LIST MODAL -->
<div class="read-overlay" id="rjOverlay" onclick="handleRjClick(event)">
  <div class="rj-modal">
    <button class="read-close" onclick="closeRjModal()">×</button>
    <div class="rj-modal-title">Your Read Letters</div>
    <p class="rj-modal-sub">Letters you've already unfolded ✦</p>
    <div id="rjModalList"></div>
  </div>
</div>

<div class="toast" id="toast">Your letter found its place ✦</div>

<script>
// ─────────────────────────────────────────────
//  STATE
// ─────────────────────────────────────────────
let letters = [];           // all letters from shared storage
let readIds = new Set();    // letter IDs this session has read
let sessionId = '';
let selectedColor = '#c8192a';
let currentReadId = null;   // letter being shown in read modal

const PALETTE = {
  '#c8192a': 'Crimson',
  '#c8a050': 'Gold',
  '#3a6bc8': 'Midnight',
  '#3a8050': 'Forest',
  '#9a2a8a': 'Plum',
  '#a08060': 'Bone',
};

// ─────────────────────────────────────────────
//  SESSION + STORAGE INIT
// ─────────────────────────────────────────────
async function init() {
  // Generate or restore session ID
  try {
    const sid = await window.storage.get('session-id');
    if (sid) {
      sessionId = sid.value;
    } else {
      sessionId = 'sess-' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
      await window.storage.set('session-id', sessionId);
    }
  } catch {
    sessionId = 'sess-' + Math.random().toString(36).slice(2,10);
    try { await window.storage.set('session-id', sessionId); } catch {}
  }

  // Load read IDs for this session
  try {
    const saved = await window.storage.get('read-ids:' + sessionId);
    if (saved) readIds = new Set(JSON.parse(saved.value));
  } catch {}

  // Load all letters from shared storage
  await loadLetters();

  // Poll for new letters every 8 seconds
  setInterval(pollLetters, 8000);
}

async function loadLetters() {
  try {
    const result = await window.storage.get('all-letters', true);
    if (result) {
      const loaded = JSON.parse(result.value);
      if (loaded.length !== letters.length) {
        letters = loaded;
        renderAll();
      }
    } else {
      letters = [];
      renderAll();
    }
  } catch {
    renderAll();
  }
}

async function pollLetters() {
  try {
    const result = await window.storage.get('all-letters', true);
    const loaded = result ? JSON.parse(result.value) : [];
    if (loaded.length !== letters.length) {
      // New letters added by another user
      const prevLen = letters.length;
      letters = loaded;
      // Only add the new slips (don't re-render everything)
      for (let i = prevLen; i < letters.length; i++) {
        addSlipToJar(letters[i], i, true);
        addCardToPanel(letters[i], i, true);
      }
      updateStats();
    }
  } catch {}
}

async function saveLetters() {
  try {
    await window.storage.set('all-letters', JSON.stringify(letters), true);
  } catch {}
}

async function saveReadIds() {
  try {
    await window.storage.set('read-ids:' + sessionId, JSON.stringify([...readIds]));
  } catch {}
}

// ─────────────────────────────────────────────
//  RENDER
// ─────────────────────────────────────────────
function renderAll() {
  // Clear jar
  const jar = document.getElementById('jarLetters');
  jar.innerHTML = '';
  if (letters.length === 0) {
    jar.innerHTML = '<div class="empty-hint" id="emptyHint">no letters yet…<br>be the first</div>';
  }

  // Clear panels
  document.getElementById('paneAll').innerHTML = '';
  document.getElementById('paneUnread').innerHTML = '';

  if (letters.length === 0) {
    document.getElementById('paneAll').innerHTML = '<p class="no-letters-hint" id="noLettersHint">The jar awaits its first<br>folded secret…</p>';
    document.getElementById('paneUnread').innerHTML = '<p class="no-letters-hint">The jar awaits its first<br>folded secret…</p>';
  }

  // Render in reverse for panels (newest first)
  for (let i = 0; i < letters.length; i++) {
    addSlipToJar(letters[i], i, false);
    addCardToPanel(letters[i], i, false);
  }

  // Read jar
  renderReadJar();
  updateStats();
}

function addSlipToJar(letter, idx, animate) {
  const container = document.getElementById('jarLetters');
  const hint = document.getElementById('emptyHint');
  if (hint) hint.remove();

  const slip = document.createElement('div');
  slip.className = 'letter-slip' + (isRead(letter.id) ? ' is-read dropped' : '');
  slip.id = 'slip-' + letter.id;
  const r = seededRand(letter.id) * 28 - 14;
  slip.style.setProperty('--r', r.toFixed(1));
  slip.style.borderLeftColor = letter.color || '#c8192a';
  if (!animate) {
    slip.style.animation = 'none';
    slip.style.opacity = isRead(letter.id) ? '0.45' : '1';
  }

  const words = (letter.body || '').split(' ');
  slip.textContent = words.slice(0, 3).join(' ') + (words.length > 3 ? '…' : '');

  if (!isRead(letter.id)) {
    const dot = document.createElement('div');
    dot.className = 'unread-dot';
    dot.id = 'dot-' + letter.id;
    slip.appendChild(dot);
  }

  slip.addEventListener('click', () => openRead(letter.id));
  container.appendChild(slip);
}

function addCardToPanel(letter, idx, prepend) {
  const allPane = document.getElementById('paneAll');
  const unreadPane = document.getElementById('paneUnread');

  // Remove hints
  const h1 = document.getElementById('noLettersHint');
  if (h1) h1.remove();

  // ALL pane card
  const card = makeCard(letter);
  if (prepend) allPane.insertBefore(card, allPane.firstChild);
  else allPane.appendChild(card);

  // UNREAD pane card (only if unread)
  if (!isRead(letter.id)) {
    const ucard = makeCard(letter);
    if (prepend) unreadPane.insertBefore(ucard, unreadPane.firstChild);
    else unreadPane.appendChild(ucard);
    updateNoUnreadHint();
  }
}

function makeCard(letter) {
  const card = document.createElement('div');
  card.className = 'recent-card' + (isRead(letter.id) ? ' card-read' : '');
  card.id = 'card-' + letter.id;
  card.style.setProperty('--env-color', letter.color || '#c8192a');

  const dotHtml = !isRead(letter.id)
    ? `<span class="card-unread-dot" id="cdot-${letter.id}"></span>`
    : '';

  card.innerHTML = `
    <div class="recent-from">${dotHtml}— ${escHtml(letter.from)}</div>
    <div class="recent-preview">${escHtml(letter.body)}</div>
  `;
  card.addEventListener('click', () => openRead(letter.id));
  return card;
}

function renderReadJar() {
  const rjContainer = document.getElementById('rjLetters');
  rjContainer.innerHTML = '';
  const readLetters = letters.filter(l => isRead(l.id));

  const section = document.getElementById('readJarSection');
  if (readLetters.length > 0) {
    section.classList.add('visible');
    document.getElementById('readBadge').textContent = readLetters.length;
    readLetters.forEach(l => {
      const slip = document.createElement('div');
      slip.className = 'rj-slip';
      const r = seededRand(l.id + 'r') * 20 - 10;
      slip.style.setProperty('--r', r.toFixed(1));
      slip.style.borderLeftColor = l.color || '#c8192a';
      slip.style.animation = 'none';
      slip.style.opacity = '0.75';
      const words = (l.body || '').split(' ');
      slip.textContent = words.slice(0, 2).join(' ') + (words.length > 2 ? '…' : '');
      rjContainer.appendChild(slip);
    });
  } else {
    section.classList.remove('visible');
  }
}

function updateStats() {
  const n = letters.length;
  const badge = document.getElementById('letterBadge');
  badge.textContent = n;

  const unreadCount = letters.filter(l => !isRead(l.id)).length;
  const ub1 = document.getElementById('unreadBadge');
  const ub2 = document.getElementById('unreadBadge2');
  if (unreadCount > 0) {
    ub1.textContent = unreadCount;
    ub1.classList.remove('hidden');
    ub2.textContent = unreadCount;
    ub2.classList.remove('hidden');
  } else {
    ub1.classList.add('hidden');
    ub2.classList.add('hidden');
  }
}

function updateNoUnreadHint() {
  const pane = document.getElementById('paneUnread');
  const unreadCards = pane.querySelectorAll('.recent-card');
  let hint = document.getElementById('noUnreadHint');
  if (unreadCards.length === 0) {
    if (!hint) {
      hint = document.createElement('p');
      hint.className = 'no-letters-hint';
      hint.id = 'noUnreadHint';
      hint.innerHTML = "You've read everything<br>in the jar ✦";
      pane.appendChild(hint);
    } else { hint.style.display = ''; }
  } else if (hint) {
    hint.style.display = 'none';
  }
}

// ─────────────────────────────────────────────
//  COLOR PICKER
// ─────────────────────────────────────────────
function selectColor(el) {
  document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
  selectedColor = el.dataset.color;
  // Update the envelope CTA icon stroke color
  updateEnvIcon(selectedColor);
}

function updateEnvIcon(color) {
  const icon = document.getElementById('envCTAIcon');
  icon.querySelectorAll('[stroke]').forEach(el => {
    const s = el.getAttribute('stroke');
    if (s && s !== 'none') el.setAttribute('stroke', color.replace('#', 'rgba(').replace(/^rgba\((.{6})\)$/, (m, h) => {
      const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
      return `rgba(${r},${g},${b},0.7)`;
    }));
  });
}

// ─────────────────────────────────────────────
//  SUBMIT
// ─────────────────────────────────────────────
async function submitLetter() {
  const from = document.getElementById('fromField').value.trim() || 'Anonymous';
  const body = document.getElementById('letterBody').value.trim();
  if (!body) {
    const ta = document.getElementById('letterBody');
    ta.style.borderColor = 'rgba(200,25,42,0.8)';
    ta.focus();
    setTimeout(() => ta.style.borderColor = '', 900);
    return;
  }

  const letter = {
    id: 'ltr-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6),
    from,
    body,
    color: selectedColor,
    ts: Date.now(),
  };

  letters.push(letter);
  await saveLetters();

  // Add to UI
  const jar = document.getElementById('jarLetters');
  const hint = document.getElementById('emptyHint');
  if (hint) hint.remove();
  addSlipToJar(letter, letters.length - 1, true);
  addCardToPanel(letter, letters.length - 1, true);

  updateStats();
  closeModal();
  showToast('Your letter found its place ✦');
  bumpBadge();
}

function bumpBadge() {
  const badge = document.getElementById('letterBadge');
  badge.classList.add('bump');
  setTimeout(() => badge.classList.remove('bump'), 400);
}

// ─────────────────────────────────────────────
//  READ
// ─────────────────────────────────────────────
function openRead(id) {
  const letter = letters.find(l => l.id === id);
  if (!letter) return;
  currentReadId = id;

  document.getElementById('readFrom').textContent = '— from ' + letter.from;
  document.getElementById('readBody').textContent = letter.body;

  const stripe = document.getElementById('readEnvStripe');
  stripe.style.background = letter.color || '#c8192a';

  const wax = document.getElementById('readWax');
  wax.querySelector('circle').setAttribute('fill', (letter.color || '#c8192a') + '80');

  document.getElementById('readOverlay').classList.add('open');

  // Mark as read
  if (!isRead(id)) {
    markRead(id);
  }
}

async function markRead(id) {
  readIds.add(id);
  await saveReadIds();

  // Update slip
  const slip = document.getElementById('slip-' + id);
  if (slip) {
    slip.classList.add('is-read', 'dropped');
    const dot = document.getElementById('dot-' + id);
    if (dot) { dot.style.transition = 'opacity 0.4s'; dot.style.opacity = '0'; setTimeout(() => dot.remove(), 400); }
  }

  // Update all cards with this id
  document.querySelectorAll('#card-' + id).forEach(card => {
    card.classList.add('card-read');
    const cdot = card.querySelector('.card-unread-dot');
    if (cdot) { cdot.style.transition = 'opacity 0.4s'; cdot.style.opacity = '0'; setTimeout(() => cdot.remove(), 400); }
  });

  // Remove from unread pane
  const unreadPane = document.getElementById('paneUnread');
  const ucards = unreadPane.querySelectorAll('#card-' + id);
  ucards.forEach(c => { c.style.transition = 'opacity 0.4s, transform 0.4s'; c.style.opacity = '0'; c.style.transform = 'translateX(8px)'; setTimeout(() => c.remove(), 420); });

  // Add to read jar with a delay
  setTimeout(() => {
    renderReadJar();
    updateStats();
    updateNoUnreadHint();
  }, 460);
}

function closeRead() {
  document.getElementById('readOverlay').classList.remove('open');
  currentReadId = null;
}

function handleReadClick(e) {
  if (e.target === document.getElementById('readOverlay')) closeRead();
}

// ─────────────────────────────────────────────
//  READ JAR MODAL
// ─────────────────────────────────────────────
function openReadJarModal() {
  const list = document.getElementById('rjModalList');
  list.innerHTML = '';
  const readLetters = letters.filter(l => isRead(l.id)).slice().reverse();

  if (readLetters.length === 0) {
    list.innerHTML = '<p class="rj-empty">Nothing read yet…</p>';
  } else {
    readLetters.forEach(l => {
      const item = document.createElement('div');
      item.className = 'rj-list-item';
      item.style.setProperty('--env-color', l.color || '#c8192a');
      item.innerHTML = `<div class="rj-item-from">— ${escHtml(l.from)}</div><div class="rj-item-preview">${escHtml(l.body)}</div>`;
      item.addEventListener('click', () => { closeRjModal(); setTimeout(() => openRead(l.id), 200); });
      list.appendChild(item);
    });
  }

  document.getElementById('rjOverlay').classList.add('open');
}

function closeRjModal() {
  document.getElementById('rjOverlay').classList.remove('open');
}

function handleRjClick(e) {
  if (e.target === document.getElementById('rjOverlay')) closeRjModal();
}

// ─────────────────────────────────────────────
//  TABS
// ─────────────────────────────────────────────
function switchTab(tab) {
  document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('pane' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

// ─────────────────────────────────────────────
//  MODAL
// ─────────────────────────────────────────────
function openModal() {
  document.getElementById('overlay').classList.add('open');
  setTimeout(() => document.getElementById('fromField').focus(), 350);
}

function closeModal() {
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('fromField').value = '';
  document.getElementById('letterBody').value = '';
  document.getElementById('charCount').textContent = '0';
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('overlay')) closeModal();
}



// ─────────────────────────────────────────────
//  UTILS
// ─────────────────────────────────────────────
function isRead(id) { return readIds.has(id); }

function seededRand(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) h = (Math.imul(31, h) + str.charCodeAt(i)) | 0;
  return (h >>> 0) / 0xFFFFFFFF;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function scrollJar() {
  document.querySelector('.jar-scene').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeRead(); closeRjModal(); }
});

// ─────────────────────────────────────────────
//  BOOT
// ─────────────────────────────────────────────
init();
</script>
</body>
</html>