<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Letter Jar</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Caveat:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #1c1409; --deep: #241a0e;
    --crimson: #8b6444; --crimson-mid: #a07850;
    --crimson-bright: #c49a6a; --rose-pink: #d4b488; --rose-light: #e2c8a0;
    --gold: #c8a050; --gold-light: #dfc070;
    --cream: #f0e4c8; --paper: #faf0d8; --ink: #241408;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background-color: var(--black); min-height: 100vh; width: 100%; font-family: 'Cormorant Garamond', serif; color: var(--cream); overflow-x: hidden; position: relative; }
  .bg-layer { position: fixed; inset: 0; background: radial-gradient(ellipse 80% 60% at 15% 10%, rgba(80,50,15,0.5) 0%, transparent 60%), radial-gradient(ellipse 60% 70% at 85% 90%, rgba(60,35,10,0.45) 0%, transparent 55%), radial-gradient(ellipse 40% 40% at 50% 50%, rgba(40,22,5,0.55) 0%, transparent 70%); pointer-events: none; z-index: 0; }
  .noise { position: fixed; inset: 0; opacity: 0.04; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)'/%3E%3C/svg%3E"); pointer-events: none; z-index: 1; }

  /* BOOKS + QUILLS */
  .book-tl, .book-br, .book-tr { position: fixed; pointer-events: none; z-index: 2; }
  .book-tl { top: -20px; left: -20px; width: 280px; transform: rotate(-15deg); opacity: 0.65; }
  .book-tr { top: -10px; right: -10px; width: 220px; transform: rotate(20deg) scaleX(-1); opacity: 0.55; }
  .book-br { bottom: -30px; right: -20px; width: 300px; transform: rotate(10deg); opacity: 0.65; }
  .quill-bl { position: fixed; bottom: -10px; left: 40px; width: 220px; transform: rotate(30deg); opacity: 0.5; pointer-events: none; z-index: 2; }
  .quill-tr2 { position: fixed; top: 80px; right: 180px; width: 160px; transform: rotate(-20deg); opacity: 0.35; pointer-events: none; z-index: 2; }
  .quill-tl2 { position: fixed; top: 60px; left: 200px; width: 140px; transform: rotate(15deg); opacity: 0.3; pointer-events: none; z-index: 2; }

  /* ── HEADER ── */
  header { position: relative; z-index: 10; width: 100%; padding: 20px 60px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(160,120,60,0.3); background: rgba(24,16,6,0.6); backdrop-filter: blur(10px); gap: 20px; }
  .logo { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.4rem; color: var(--gold-light); letter-spacing: 0.05em; white-space: nowrap; flex-shrink: 0; }

  /* JAR SELECTOR in header */
  .jar-selector-wrap { position: relative; flex: 1; max-width: 340px; }
  .jar-selector-btn {
    display: flex; align-items: center; gap: 8px;
    background: rgba(255,255,255,0.04); border: 1px solid rgba(160,120,60,0.35);
    border-radius: 2px; padding: 8px 14px;
    font-family: 'Playfair Display', serif; font-style: italic; font-size: 0.95rem;
    color: var(--cream); cursor: pointer; width: 100%;
    transition: border-color 0.2s, background 0.2s;
  }
  .jar-selector-btn:hover { border-color: rgba(180,140,70,0.6); background: rgba(255,255,255,0.07); }
  .jar-selector-btn .jar-name-display { flex: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .jar-selector-btn .chevron { font-size: 0.65rem; color: rgba(245,232,224,0.35); transition: transform 0.2s; flex-shrink: 0; }
  .jar-selector-wrap.open .chevron { transform: rotate(180deg); }

  .jar-dropdown {
    position: absolute; top: calc(100% + 6px); left: 0; right: 0;
    background: #1e160a; border: 1px solid rgba(160,120,60,0.35);
    border-radius: 3px; z-index: 50;
    box-shadow: 0 20px 50px rgba(0,0,0,0.8), 0 0 30px rgba(40,20,5,0.2);
    overflow: hidden;
    display: none; flex-direction: column;
    max-height: 280px;
  }
  .jar-selector-wrap.open .jar-dropdown { display: flex; }
  .jar-dropdown-scroll { overflow-y: auto; flex: 1; }
  .jar-dropdown-scroll::-webkit-scrollbar { width: 3px; }
  .jar-dropdown-scroll::-webkit-scrollbar-thumb { background: rgba(180,140,70,0.38); }

  .jar-option {
    display: flex; align-items: center; justify-content: space-between;
    padding: 11px 16px; cursor: pointer;
    font-family: 'Cormorant Garamond', serif; font-size: 1rem; color: rgba(245,235,210,0.7);
    transition: background 0.15s, color 0.15s;
    border-bottom: 1px solid rgba(160,120,60,0.15);
    gap: 8px;
  }
  .jar-option:last-child { border-bottom: none; }
  .jar-option:hover { background: rgba(180,140,70,0.15); color: var(--cream); }
  .jar-option.active-jar { color: var(--gold-light); font-style: italic; }
  .jar-option .jar-opt-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .jar-opt-count { font-size: 0.75rem; color: rgba(245,235,210,0.3); flex-shrink: 0; }
  .jar-opt-del {
    background: none; border: none; color: rgba(245,235,210,0.2);
    font-size: 0.9rem; cursor: pointer; padding: 2px 4px;
    transition: color 0.2s; flex-shrink: 0;
    line-height: 1;
  }
  .jar-opt-del:hover { color: var(--rose-pink); }

  .jar-dropdown-footer {
    border-top: 1px solid rgba(160,120,60,0.28);
    padding: 10px 16px;
  }
  .create-jar-btn {
    width: 100%; background: none; border: 1px dashed rgba(180,140,70,0.38);
    border-radius: 2px; padding: 9px; cursor: pointer;
    font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.9rem;
    color: rgba(180,140,70,0.8); transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .create-jar-btn:hover { border-color: rgba(180,140,70,0.65); color: var(--rose-light); background: rgba(180,140,70,0.1); }

  nav { display: flex; gap: 28px; flex-shrink: 0; }
  nav a { font-family: 'Cormorant Garamond', serif; font-size: 0.88rem; letter-spacing: 0.15em; text-transform: uppercase; color: rgba(245,232,224,0.45); text-decoration: none; cursor: pointer; transition: color 0.3s; }
  nav a:hover { color: var(--rose-light); }

  /* HERO */
  .hero { position: relative; z-index: 5; display: grid; grid-template-columns: 1fr 460px 1fr; min-height: calc(100vh - 81px); align-items: center; padding: 60px 80px; gap: 50px; }

  /* LEFT */
  .hero-left { animation: fadeLeft 1.2s ease both; }
  @keyframes fadeLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
  .eyebrow { font-size: 0.75rem; letter-spacing: 0.32em; text-transform: uppercase; color: var(--crimson-bright); margin-bottom: 22px; display: flex; align-items: center; gap: 10px; }
  .eyebrow::before { content: ''; display: block; width: 28px; height: 1px; background: var(--crimson-bright); }
  .hero-title { font-family: 'Playfair Display', serif; font-size: clamp(2.8rem, 4vw, 5rem); font-weight: 700; line-height: 1.08; color: var(--cream); margin-bottom: 22px; }
  .hero-title em { font-style: italic; color: var(--rose-pink); display: block; }
  .hero-desc { font-size: 1.1rem; line-height: 1.85; color: rgba(245,235,210,0.55); max-width: 350px; margin-bottom: 36px; }
  .cta-group { display: flex; gap: 14px; flex-wrap: wrap; }
  .btn-primary { background: var(--crimson); border: 1px solid var(--crimson-mid); border-radius: 2px; padding: 13px 32px; font-family: 'Playfair Display', serif; font-style: italic; font-size: 1rem; color: var(--cream); cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(100,60,15,0.45), inset 0 1px 0 rgba(255,255,255,0.06); }
  .btn-primary:hover { background: var(--crimson-bright); transform: translateY(-2px); box-shadow: 0 8px 28px rgba(180,140,70,0.5); }
  .btn-ghost { background: none; border: 1px solid rgba(245,235,210,0.18); border-radius: 2px; padding: 13px 26px; font-family: 'Cormorant Garamond', serif; font-size: 1rem; color: rgba(245,235,210,0.55); cursor: pointer; transition: all 0.3s; }
  .btn-ghost:hover { border-color: rgba(245,238,220,0.45); color: var(--cream); }

  /* Current jar name display on left */
  .jar-context {
    margin-top: 38px; padding-top: 26px;
    border-top: 1px solid rgba(160,120,60,0.25);
  }
  .jar-context-label { font-size: 0.72rem; letter-spacing: 0.28em; text-transform: uppercase; color: rgba(180,140,70,0.65); margin-bottom: 6px; }
  .jar-context-name { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.8rem; color: var(--cream); line-height: 1.1; }
  .jar-context-count { font-style: italic; font-size: 0.9rem; color: rgba(245,235,210,0.3); margin-top: 4px; }

  /* CENTER: JAR */
  .jar-col { display: flex; flex-direction: column; align-items: center; position: relative; animation: fadeUp 1.2s ease 0.25s both; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  .jar-glow { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 340px; height: 340px; background: radial-gradient(ellipse, rgba(180,210,230,0.12) 0%, transparent 70%); pointer-events: none; filter: blur(24px); }
  .jar-scene { position: relative; width: 280px; height: 390px; flex-shrink: 0; }
  .jar-svg { position: absolute; inset: 0; width: 100%; height: 100%; filter: drop-shadow(0 30px 50px rgba(0,0,0,0.6)) drop-shadow(0 0 30px rgba(180,210,230,0.1)); }
  .jar-letters { position: absolute; bottom: 28px; left: 50%; transform: translateX(-50%); width: 170px; display: flex; flex-wrap: wrap; align-items: flex-end; justify-content: center; gap: 4px; padding: 6px; overflow: hidden; max-height: 275px; }

  .letter-slip { width: 36px; height: 26px; transform: rotate(calc(var(--r) * 1deg)); animation: dropIn 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards; opacity: 0; cursor: pointer; transition: filter 0.2s, opacity 0.4s; position: relative; flex-shrink: 0; }
  .letter-slip:hover { filter: brightness(1.18) drop-shadow(0 2px 5px rgba(0,0,0,0.6)); }
  .letter-slip.is-read.dropped { opacity: 0.45; }
  .letter-slip svg { width: 100%; height: 100%; }
  /* Heart button */
  .heart-btn { background: none; border: none; cursor: pointer; padding: 4px 6px; display: inline-flex; align-items: center; gap: 5px; font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.82rem; color: rgba(245,235,210,0.35); transition: color 0.2s, transform 0.2s; line-height: 1; }
  .heart-btn:hover { color: rgba(220,80,80,0.8); transform: scale(1.1); }
  .heart-btn.hearted { color: #e05060; }
  .heart-btn svg { width: 14px; height: 14px; flex-shrink: 0; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); }
  .heart-btn.hearted svg { transform: scale(1.2); }
  .heart-btn .heart-count { font-size: 0.78rem; }
  /* Heart in read modal */
  .read-heart-wrap { position: absolute; bottom: 20px; left: 24px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .read-heart-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 4px; transition: transform 0.2s; }
  .read-heart-btn:hover { transform: scale(1.12); }
  .read-heart-btn svg { width: 28px; height: 28px; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); }
  .read-heart-btn.hearted svg { transform: scale(1.18); }
  .read-heart-label { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.62rem; letter-spacing: 0.12em; color: rgba(180,140,70,0.5); text-transform: uppercase; pointer-events: none; }
  .read-heart-count { font-family: 'Playfair Display', serif; font-size: 0.8rem; color: rgba(245,235,210,0.45); }
  @keyframes dropIn { from { opacity: 0; transform: rotate(calc(var(--r)*1deg)) translateY(-40px) scale(0.8); } to { opacity: 1; transform: rotate(calc(var(--r)*1deg)) translateY(0) scale(1); } }

  .shared-banner { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; align-items: center; gap: 8px; padding: 8px 18px; border-radius: 20px; font-family: 'Cormorant Garamond', serif; font-size: 0.82rem; letter-spacing: 0.08em; pointer-events: none; transition: opacity 0.5s; }
  .shared-banner.live { background: rgba(10,30,10,0.85); border: 1px solid rgba(40,160,60,0.35); color: rgba(100,220,120,0.8); }
  .shared-banner.local { background: rgba(30,20,5,0.85); border: 1px solid rgba(200,160,60,0.3); color: rgba(210,170,80,0.7); }
  .shared-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .shared-banner.live .shared-dot { background: #40c060; box-shadow: 0 0 6px rgba(60,200,80,0.7); animation: pulse-dot 1.8s ease-in-out infinite; }
  .shared-banner.local .shared-dot { background: #c8a040; }
  .unread-dot { position: absolute; top: 3px; right: 3px; width: 5px; height: 5px; border-radius: 50%; background: var(--crimson-bright); box-shadow: 0 0 4px rgba(180,140,70,0.9); animation: pulse-dot 1.8s ease-in-out infinite; }
  @keyframes pulse-dot { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.4); opacity: 0.6; } }

  .empty-hint { font-style: italic; font-size: 0.78rem; color: rgba(90,120,60,0.35); text-align: center; position: absolute; bottom: 38px; left: 50%; transform: translateX(-50%); width: 140px; pointer-events: none; line-height: 1.6; }

  .letter-badge { position: absolute; top: 8px; right: -18px; background: var(--crimson); border: 2px solid rgba(180,140,70,0.42); color: var(--cream); font-family: 'Playfair Display', serif; font-size: 13px; font-weight: 700; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 14px rgba(0,0,0,0.5), 0 0 20px rgba(120,80,30,0.35); transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); z-index: 20; }
  .letter-badge.bump { transform: scale(1.5); }

  .env-cta { margin-top: 28px; display: flex; flex-direction: column; align-items: center; gap: 9px; cursor: pointer; background: none; border: none; color: rgba(245,238,220,0.4); font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.9rem; letter-spacing: 0.07em; transition: color 0.3s; }
  .env-cta:hover { color: var(--rose-light); }
  .env-cta:hover .env-icon { filter: drop-shadow(0 0 14px rgba(180,140,70,0.7)); transform: translateY(-3px); }
  .env-icon { width: 58px; height: 42px; transition: filter 0.3s, transform 0.3s; }

  /* RIGHT */
  .hero-right { display: flex; flex-direction: column; gap: 18px; animation: fadeRight 1.2s ease 0.15s both; }
  @keyframes fadeRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }

  .panel-tabs { display: flex; gap: 0; border-bottom: 1px solid rgba(160,120,60,0.28); margin-bottom: 4px; }
  .panel-tab { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.95rem; color: rgba(245,235,210,0.35); padding: 6px 18px 10px 0; cursor: pointer; border-bottom: 2px solid transparent; transition: color 0.2s, border-color 0.2s; position: relative; bottom: -1px; background: none; border-top: none; border-left: none; border-right: none; }
  .panel-tab.active { color: var(--gold-light); border-bottom: 2px solid var(--crimson); }
  .panel-tab:hover:not(.active) { color: rgba(245,235,210,0.65); }
  .tab-badge { display: inline-flex; align-items: center; justify-content: center; background: var(--crimson); color: var(--cream); font-size: 0.65rem; font-style: normal; width: 16px; height: 16px; border-radius: 50%; margin-left: 5px; vertical-align: middle; font-family: 'Playfair Display', serif; font-weight: 700; }
  .tab-badge.hidden { display: none; }

  .recent-title { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.15rem; color: var(--gold-light); display: flex; align-items: center; gap: 12px; }
  .recent-title::after { content: ''; flex: 1; height: 1px; background: rgba(200,160,80,0.2); min-width: 16px; }

  .tab-pane { display: none; flex-direction: column; gap: 11px; max-height: 380px; overflow-y: auto; padding-right: 4px; }
  .tab-pane.active { display: flex; }
  .tab-pane::-webkit-scrollbar { width: 3px; }
  .tab-pane::-webkit-scrollbar-thumb { background: rgba(180,140,70,0.3); border-radius: 2px; }

  .recent-card { background: rgba(35,22,8,0.6); border: 1px solid rgba(150,110,50,0.22); border-radius: 3px; padding: 15px 18px; backdrop-filter: blur(6px); cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; flex-shrink: 0; }
  .recent-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--env-color, var(--crimson)); }
  .recent-card:hover { border-color: rgba(180,140,70,0.4); background: rgba(45,28,10,0.7); transform: translateX(4px); }
  .recent-card.card-read { opacity: 0.55; }
  .recent-from { font-family: 'Caveat', cursive; font-size: 0.8rem; color: var(--crimson-bright); margin-bottom: 5px; letter-spacing: 0.04em; display: flex; align-items: center; gap: 8px; }
  .recent-preview { font-family: 'Caveat', cursive; font-size: 1rem; color: rgba(245,235,210,0.65); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-unread-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--crimson-bright); box-shadow: 0 0 5px rgba(180,140,70,0.8); flex-shrink: 0; animation: pulse-dot 1.8s ease-in-out infinite; }
  .no-letters-hint { font-style: italic; font-size: 1rem; color: rgba(245,235,210,0.22); line-height: 1.75; }

  /* COLOR SWATCHES */
  .color-picker-row { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; }
  .color-picker-label { font-size: 0.76rem; letter-spacing: 0.22em; text-transform: uppercase; color: rgba(245,232,224,0.38); margin-right: 4px; }
  .swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s; flex-shrink: 0; }
  .swatch:hover { transform: scale(1.15); }
  .swatch.selected { border-color: rgba(245,235,210,0.7); box-shadow: 0 0 0 2px rgba(180,140,70,0.5); transform: scale(1.15); }

  /* WRITE MODAL */
  .overlay { position: fixed; inset: 0; background: rgba(5,3,1,0.88); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.4s; padding: 20px; }
  .overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: #1e160a; border: 1px solid rgba(160,120,60,0.35); border-radius: 4px; padding: 50px 52px; max-width: 520px; width: 100%; color: var(--cream); box-shadow: 0 40px 100px rgba(0,0,0,0.85), 0 0 60px rgba(80,50,18,0.2); transform: scale(0.88) translateY(24px); transition: transform 0.45s cubic-bezier(0.34,1.56,0.64,1); position: relative; background-image: radial-gradient(ellipse at 100% 0%, rgba(100,65,20,0.18) 0%, transparent 60%); }
  .overlay.open .modal { transform: scale(1) translateY(0); }
  .modal-book { position: absolute; top: -12px; right: -12px; width: 100px; opacity: 0.45; transform: rotate(25deg); pointer-events: none; }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 1.9rem; font-weight: 400; font-style: italic; color: var(--cream); margin-bottom: 6px; }
  .modal-sub { font-style: italic; font-size: 1rem; color: rgba(245,232,224,0.38); margin-bottom: 10px; }
  .divider { width: 36px; height: 1px; background: var(--crimson); margin: 16px 0 28px; }
  label { display: block; font-size: 0.76rem; letter-spacing: 0.22em; text-transform: uppercase; color: rgba(245,235,210,0.38); margin-bottom: 8px; }
  input[type="text"], textarea { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(160,120,60,0.3); border-radius: 2px; padding: 12px 16px; font-family: 'Caveat', cursive; font-size: 1.15rem; color: var(--cream); outline: none; resize: none; transition: border-color 0.2s, box-shadow 0.2s; margin-bottom: 20px; }
  input[type="text"]::placeholder, textarea::placeholder { color: rgba(245,235,210,0.18); }
  input[type="text"]:focus, textarea:focus { border-color: rgba(180,140,70,0.6); box-shadow: 0 0 0 3px rgba(180,140,70,0.1); }
  .modal-actions { display: flex; gap: 14px; justify-content: flex-end; margin-top: 8px; }
  .btn-cancel-modal { background: none; border: 1px solid rgba(245,235,210,0.14); border-radius: 2px; padding: 11px 22px; font-family: 'Cormorant Garamond', serif; font-size: 1rem; color: rgba(245,235,210,0.38); cursor: pointer; transition: all 0.2s; }
  .btn-cancel-modal:hover { border-color: rgba(245,235,210,0.35); color: var(--cream); }
  .btn-submit-modal { background: var(--crimson); border: 1px solid var(--crimson-mid); border-radius: 2px; padding: 11px 30px; font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.05rem; color: var(--cream); cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(100,60,15,0.45); }
  .btn-submit-modal:hover { background: var(--crimson-bright); transform: translateY(-2px); box-shadow: 0 8px 28px rgba(180,140,70,0.5); }

  /* CREATE JAR MODAL */
  .create-jar-modal { max-width: 420px; }
  .create-jar-modal .modal-title { font-size: 1.6rem; }

  /* READ LETTER MODAL */
  .read-overlay { position: fixed; inset: 0; background: rgba(5,3,1,0.92); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; padding: 20px; }
  .read-overlay.open { opacity: 1; pointer-events: all; }
  .read-modal { background: #1e160a; border: 1px solid rgba(160,120,60,0.3); border-radius: 4px; padding: 48px 54px; max-width: 460px; width: 100%; color: var(--cream); box-shadow: 0 40px 80px rgba(0,0,0,0.85), 0 0 40px rgba(80,50,18,0.2); transform: scale(0.9) rotate(-1.5deg); transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1); position: relative; }
  .read-overlay.open .read-modal { transform: scale(1) rotate(0deg); }
  .read-close { position: absolute; top: 14px; right: 18px; background: none; border: none; font-size: 1.6rem; color: rgba(245,235,210,0.28); cursor: pointer; transition: color 0.2s; }
  .read-close:hover { color: var(--rose-pink); }
  .read-wax-wrap { position: absolute; bottom: 20px; right: 24px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .read-wax { width: 34px; height: 34px; cursor: pointer; transition: transform 0.2s, filter 0.2s; }
  .read-wax:hover { transform: scale(1.15); filter: drop-shadow(0 0 8px rgba(180,140,70,0.7)); }
  .read-wax-label { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.62rem; letter-spacing: 0.12em; color: rgba(180,140,70,0.5); text-transform: uppercase; pointer-events: none; }
  .read-delete-confirm { display: none; position: absolute; bottom: calc(100% + 10px); right: -10px; background: #1e160a; border: 1px solid rgba(180,140,70,0.42); border-radius: 3px; padding: 12px 14px; white-space: nowrap; box-shadow: 0 10px 30px rgba(0,0,0,0.7); z-index: 10; }
  .read-delete-confirm::after { content: ''; position: absolute; bottom: -6px; right: 20px; width: 10px; height: 10px; background: #1e160a; border-right: 1px solid rgba(180,140,70,0.42); border-bottom: 1px solid rgba(180,140,70,0.42); transform: rotate(45deg); }
  .read-delete-confirm.visible { display: block; animation: fadeUp 0.2s ease; }
  .read-delete-confirm-text { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: 0.92rem; color: rgba(245,238,220,0.75); display: block; margin-bottom: 10px; }
  .read-delete-confirm-btns { display: flex; gap: 8px; justify-content: flex-end; }
  .rdc-btn { font-family: 'Cormorant Garamond', serif; font-size: 0.85rem; padding: 5px 14px; border-radius: 2px; cursor: pointer; transition: all 0.2s; border: 1px solid; }
  .rdc-cancel { background: none; border-color: rgba(245,238,220,0.15); color: rgba(245,238,220,0.45); }
  .rdc-cancel:hover { border-color: rgba(245,235,210,0.35); color: var(--cream); }
  .rdc-confirm { background: rgba(100,65,20,0.5); border-color: rgba(180,140,70,0.5); color: var(--cream); }
  .rdc-confirm:hover { background: var(--crimson-bright); border-color: var(--crimson-bright); }
  .read-from { font-style: italic; font-size: 0.85rem; letter-spacing: 0.1em; color: var(--crimson-bright); margin-bottom: 16px; }
  .read-divider { width: 28px; height: 1px; background: rgba(160,120,60,0.45); margin-bottom: 20px; }
  .read-body { font-family: 'Caveat', cursive; font-size: 1.4rem; line-height: 1.85; color: rgba(245,238,220,0.85); white-space: pre-wrap; min-height: 80px; max-height: 55vh; overflow-y: auto; padding-right: 4px; }
  .read-body::-webkit-scrollbar { width: 3px; }
  .read-body::-webkit-scrollbar-thumb { background: rgba(180,140,70,0.3); }
  .read-env-stripe { height: 3px; border-radius: 2px; margin-bottom: 24px; width: 100%; }

  /* READ JAR LIST MODAL */
  .rj-modal { background: #1e160a; border: 1px solid rgba(160,120,60,0.3); border-radius: 4px; padding: 40px 44px; max-width: 440px; width: 100%; color: var(--cream); box-shadow: 0 30px 70px rgba(0,0,0,0.85); transform: scale(0.88) translateY(20px); transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1); max-height: 80vh; overflow-y: auto; position: relative; }
  .read-overlay.open .rj-modal { transform: scale(1) translateY(0); }
  .rj-modal::-webkit-scrollbar { width: 3px; }
  .rj-modal::-webkit-scrollbar-thumb { background: rgba(180,140,70,0.32); }
  .rj-modal-title { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.5rem; color: var(--cream); margin-bottom: 6px; }
  .rj-modal-sub { font-style: italic; font-size: 0.9rem; color: rgba(245,232,224,0.35); margin-bottom: 24px; }
  .rj-list-item { border: 1px solid rgba(150,110,50,0.2); border-radius: 2px; padding: 14px 16px; margin-bottom: 10px; cursor: pointer; transition: all 0.25s; background: rgba(35,22,8,0.5); position: relative; overflow: hidden; }
  .rj-list-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--env-color, var(--crimson)); }
  .rj-list-item:hover { background: rgba(45,28,10,0.65); border-color: rgba(180,140,70,0.32); transform: translateX(3px); }
  .rj-item-from { font-family: 'Caveat', cursive; font-size: 0.8rem; color: var(--crimson-bright); margin-bottom: 4px; }
  .rj-item-preview { font-family: 'Caveat', cursive; font-size: 1rem; color: rgba(245,235,210,0.6); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .rj-empty { font-style: italic; color: rgba(245,235,210,0.25); font-size: 1rem; margin-top: 10px; }

  /* DELETE CONFIRM */
  .confirm-text { font-style: italic; font-size: 1rem; color: rgba(245,235,210,0.55); line-height: 1.7; margin-bottom: 28px; }
  .confirm-name { color: var(--rose-pink); font-style: normal; }
  .btn-danger { background: rgba(100,65,20,0.65); border: 1px solid var(--crimson); border-radius: 2px; padding: 11px 26px; font-family: 'Playfair Display', serif; font-style: italic; font-size: 1rem; color: var(--cream); cursor: pointer; transition: all 0.3s; }
  .btn-danger:hover { background: var(--crimson-bright); }

  /* TOAST */
  .toast { position: fixed; bottom: 36px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--crimson); color: var(--cream); padding: 12px 28px; border-radius: 2px; font-style: italic; font-size: 1.05rem; box-shadow: 0 6px 30px rgba(0,0,0,0.55), 0 0 20px rgba(110,65,15,0.4); opacity: 0; transition: all 0.4s cubic-bezier(0.34,1.56,0.64,1); z-index: 400; pointer-events: none; border: 1px solid rgba(180,140,70,0.4); }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  footer { position: relative; z-index: 10; text-align: center; padding: 18px; border-top: 1px solid rgba(160,120,60,0.15); font-style: italic; font-size: 0.82rem; color: rgba(245,235,210,0.18); }
</style>
</head>
<body>
<div class="bg-layer"></div>
<div class="noise"></div>

<!-- BOOK TL -->
<svg class="book-tl" viewBox="0 0 280 320" xmlns="http://www.w3.org/2000/svg">
  <!-- Stacked books -->
  <g transform="translate(20, 80) rotate(-10)">
    <rect x="20" y="130" width="170" height="26" rx="2" fill="#7a5a32" stroke="#9a7048" stroke-width="1"/>
    <rect x="20" y="130" width="11" height="26" rx="1" fill="#7a5a38"/>
    <rect x="25" y="100" width="155" height="32" rx="2" fill="#8a6238" stroke="#c09060" stroke-width="1"/>
    <rect x="25" y="100" width="13" height="32" rx="1" fill="#6a4828"/>
    <rect x="30" y="65" width="145" height="37" rx="2" fill="#7a5a38" stroke="#9a7048" stroke-width="1"/>
    <rect x="30" y="65" width="12" height="37" rx="1" fill="#7a5a38"/>
    <text x="105" y="89" text-anchor="middle" font-family="Cormorant Garamond, serif" font-style="italic" font-size="9" fill="rgba(200,165,110,0.5)">Verses</text>
  </g>
  <!-- Open book -->
  <g transform="translate(60, -10) rotate(6)">
    <path d="M140,45 Q95,40 55,56 L55,150 Q95,136 140,140 Z" fill="#fdf0d0" stroke="#c8a060" stroke-width="0.8" opacity="0.9"/>
    <path d="M140,45 Q185,40 225,56 L225,150 Q185,136 140,140 Z" fill="#f8e8c8" stroke="#c8a060" stroke-width="0.8" opacity="0.9"/>
    <line x1="140" y1="45" x2="140" y2="140" stroke="#b08858" stroke-width="1.5"/>
    <line x1="72" y1="70" x2="128" y2="67" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="72" y1="81" x2="126" y2="78" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="72" y1="92" x2="128" y2="89" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="72" y1="103" x2="124" y2="100" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="152" y1="70" x2="208" y2="67" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="152" y1="81" x2="210" y2="78" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="152" y1="92" x2="206" y2="89" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="152" y1="103" x2="208" y2="100" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <text x="140" y="133" text-anchor="middle" font-size="8" fill="rgba(200,155,90,0.5)">✦</text>
  </g>
</svg>

<!-- BOOK TR -->
<svg class="book-tr" viewBox="0 0 220 260" xmlns="http://www.w3.org/2000/svg">
  <!-- Single open book, smaller -->
  <g transform="translate(10, 20) rotate(-4)">
    <path d="M110,30 Q70,26 35,40 L35,120 Q70,108 110,112 Z" fill="#fdf0d0" stroke="#c8a060" stroke-width="0.8" opacity="0.85"/>
    <path d="M110,30 Q150,26 185,40 L185,120 Q150,108 110,112 Z" fill="#f8e8c8" stroke="#c8a060" stroke-width="0.8" opacity="0.85"/>
    <line x1="110" y1="30" x2="110" y2="112" stroke="#b08858" stroke-width="1.2"/>
    <line x1="50" y1="52" x2="98" y2="49" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.35"/>
    <line x1="50" y1="62" x2="96" y2="59" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.35"/>
    <line x1="50" y1="72" x2="98" y2="69" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.35"/>
    <line x1="122" y1="52" x2="170" y2="49" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.35"/>
    <line x1="122" y1="62" x2="172" y2="59" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.35"/>
    <line x1="122" y1="72" x2="168" y2="69" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.35"/>
  </g>
  <!-- Small stacked books below -->
  <g transform="translate(15, 145) rotate(4)">
    <rect x="0" y="20" width="140" height="22" rx="2" fill="#7a5a38" stroke="#9a7048" stroke-width="0.8"/>
    <rect x="0" y="20" width="10" height="22" rx="1" fill="#7a5a38"/>
    <rect x="8" y="0" width="128" height="22" rx="2" fill="#8a6238" stroke="#c09060" stroke-width="0.8"/>
    <rect x="8" y="0" width="10" height="22" rx="1" fill="#6a4828"/>
  </g>
</svg>

<!-- BOOK BR -->
<svg class="book-br" viewBox="0 0 300 340" xmlns="http://www.w3.org/2000/svg">
  <!-- Stack of books, bottom right -->
  <g transform="translate(60, 80) rotate(8)">
    <rect x="10" y="140" width="185" height="30" rx="2" fill="#7a5a32" stroke="#9a7048" stroke-width="1"/>
    <rect x="10" y="140" width="13" height="30" rx="1" fill="#7a5a38"/>
    <rect x="16" y="108" width="172" height="34" rx="2" fill="#8a6238" stroke="#c09060" stroke-width="1"/>
    <rect x="16" y="108" width="14" height="34" rx="1" fill="#6a4828"/>
    <text x="102" y="130" text-anchor="middle" font-family="Cormorant Garamond, serif" font-style="italic" font-size="9" fill="rgba(200,165,110,0.5)">Letters</text>
    <rect x="22" y="72" width="158" height="38" rx="2" fill="#7a5a38" stroke="#9a7048" stroke-width="1"/>
    <rect x="22" y="72" width="13" height="38" rx="1" fill="#7a5a38"/>
    <text x="102" y="96" text-anchor="middle" font-family="Cormorant Garamond, serif" font-style="italic" font-size="9" fill="rgba(200,165,110,0.5)">Sonnets</text>
  </g>
  <!-- Open book on top -->
  <g transform="translate(80, -15) rotate(-5)">
    <path d="M150,50 Q105,44 65,60 L65,158 Q105,144 150,148 Z" fill="#fdf0d0" stroke="#c8a060" stroke-width="0.8" opacity="0.88"/>
    <path d="M150,50 Q195,44 235,60 L235,158 Q195,144 150,148 Z" fill="#f8e8c8" stroke="#c8a060" stroke-width="0.8" opacity="0.88"/>
    <line x1="150" y1="50" x2="150" y2="148" stroke="#b08858" stroke-width="1.5"/>
    <line x1="82" y1="76" x2="138" y2="73" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="82" y1="88" x2="136" y2="85" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="82" y1="100" x2="138" y2="97" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="82" y1="112" x2="134" y2="109" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="162" y1="76" x2="218" y2="73" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="162" y1="88" x2="220" y2="85" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="162" y1="100" x2="216" y2="97" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <line x1="162" y1="112" x2="218" y2="109" stroke="#c09060" stroke-width="0.7" stroke-linecap="round" opacity="0.4"/>
    <text x="150" y="141" text-anchor="middle" font-size="8" fill="rgba(200,155,90,0.5)">✦</text>
  </g>
</svg>


<!-- QUILL BL — large, bottom left -->
<svg class="quill-bl" viewBox="0 0 200 480" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(100,230)">
  <path d="M 0,-140.0 L -0.0,-140.0 L -10.7,-124.4 L -21.3,-108.9 L -32.0,-93.3 L -42.5,-77.8 L -53.1,-62.2 L -63.6,-46.7 L -71.6,-31.1 L -67.3,-15.6 L -62.7,0.0 L -57.9,15.6 L -52.9,31.1 L -47.5,46.7 L -41.8,62.2 L -35.7,77.8 L -29.2,93.3 L -21.9,108.9 L -13.4,124.4 L -0.0,140.0 L 0,140.0 L -0.0,140.0 L 4.5,124.4 L 7.7,108.9 L 10.6,93.3 L 13.3,77.8 L 15.9,62.2 L 18.4,46.7 L 20.9,31.1 L 23.4,15.6 L 26.0,0.0 L 28.5,-15.6 L 31.1,-31.1 L 33.7,-46.7 L 29.7,-62.2 L 23.7,-77.8 L 17.7,-93.3 L 11.8,-108.9 L 5.9,-124.4 L 0.0,-140.0 Z" fill="#c8a050" fill-opacity="0.14" stroke="#c8a050" stroke-opacity="0.6" stroke-width="0.9" stroke-linejoin="round"/>
  <path d="M 0,-140.0 Q -5.0,0.0 1,140.0" fill="none" stroke="#c8a050" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="-0.2" y1="-131.6" x2="-4.5" y2="-127.4" stroke="#c8a050" stroke-width="0.4" opacity="0.32" stroke-linecap="round"/>
  <line x1="-0.2" y1="-131.6" x2="2.5" y2="-129.0" stroke="#c8a050" stroke-width="0.4" opacity="0.26" stroke-linecap="round"/>
  <line x1="-0.5" y1="-122.5" x2="-9.5" y2="-114.0" stroke="#c8a050" stroke-width="0.4" opacity="0.35" stroke-linecap="round"/>
  <line x1="-0.5" y1="-122.5" x2="5.2" y2="-117.2" stroke="#c8a050" stroke-width="0.4" opacity="0.28" stroke-linecap="round"/>
  <line x1="-0.7" y1="-113.4" x2="-14.7" y2="-100.8" stroke="#c8a050" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-0.7" y1="-113.4" x2="8.1" y2="-105.5" stroke="#c8a050" stroke-width="0.4" opacity="0.29" stroke-linecap="round"/>
  <line x1="-1.0" y1="-104.4" x2="-20.0" y2="-87.7" stroke="#c8a050" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.0" y1="-104.4" x2="11.0" y2="-93.9" stroke="#c8a050" stroke-width="0.4" opacity="0.31" stroke-linecap="round"/>
  <line x1="-1.2" y1="-95.3" x2="-25.5" y2="-74.8" stroke="#c8a050" stroke-width="0.4" opacity="0.41" stroke-linecap="round"/>
  <line x1="-1.2" y1="-95.3" x2="14.1" y2="-82.4" stroke="#c8a050" stroke-width="0.4" opacity="0.33" stroke-linecap="round"/>
  <line x1="-1.4" y1="-86.2" x2="-31.0" y2="-62.1" stroke="#c8a050" stroke-width="0.4" opacity="0.43" stroke-linecap="round"/>
  <line x1="-1.4" y1="-86.2" x2="17.2" y2="-71.0" stroke="#c8a050" stroke-width="0.4" opacity="0.34" stroke-linecap="round"/>
  <line x1="-1.6" y1="-77.1" x2="-36.7" y2="-49.5" stroke="#c8a050" stroke-width="0.4" opacity="0.45" stroke-linecap="round"/>
  <line x1="-1.6" y1="-77.1" x2="20.4" y2="-59.7" stroke="#c8a050" stroke-width="0.4" opacity="0.36" stroke-linecap="round"/>
  <line x1="-1.8" y1="-68.1" x2="-42.5" y2="-37.1" stroke="#c8a050" stroke-width="0.4" opacity="0.47" stroke-linecap="round"/>
  <line x1="-1.8" y1="-68.1" x2="23.8" y2="-48.6" stroke="#c8a050" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-2.0" y1="-59.0" x2="-48.3" y2="-24.9" stroke="#c8a050" stroke-width="0.4" opacity="0.48" stroke-linecap="round"/>
  <line x1="-2.0" y1="-59.0" x2="27.2" y2="-37.6" stroke="#c8a050" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-2.1" y1="-49.9" x2="-54.3" y2="-12.9" stroke="#c8a050" stroke-width="0.55" opacity="0.50" stroke-linecap="round"/>
  <line x1="-2.1" y1="-49.9" x2="30.5" y2="-26.8" stroke="#c8a050" stroke-width="0.55" opacity="0.40" stroke-linecap="round"/>
  <line x1="-2.2" y1="-40.8" x2="-60.4" y2="-1.1" stroke="#c8a050" stroke-width="0.55" opacity="0.51" stroke-linecap="round"/>
  <line x1="-2.2" y1="-40.8" x2="29.5" y2="-19.1" stroke="#c8a050" stroke-width="0.55" opacity="0.41" stroke-linecap="round"/>
  <line x1="-2.3" y1="-31.8" x2="-65.0" y2="9.5" stroke="#c8a050" stroke-width="0.55" opacity="0.52" stroke-linecap="round"/>
  <line x1="-2.3" y1="-31.8" x2="28.4" y2="-11.5" stroke="#c8a050" stroke-width="0.55" opacity="0.42" stroke-linecap="round"/>
  <line x1="-2.4" y1="-22.7" x2="-63.4" y2="16.1" stroke="#c8a050" stroke-width="0.55" opacity="0.53" stroke-linecap="round"/>
  <line x1="-2.4" y1="-22.7" x2="27.4" y2="-3.8" stroke="#c8a050" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.5" y1="-13.6" x2="-61.7" y2="22.6" stroke="#c8a050" stroke-width="0.55" opacity="0.54" stroke-linecap="round"/>
  <line x1="-2.5" y1="-13.6" x2="26.3" y2="4.0" stroke="#c8a050" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.5" y1="-4.5" x2="-59.8" y2="29.2" stroke="#c8a050" stroke-width="0.55" opacity="0.55" stroke-linecap="round"/>
  <line x1="-2.5" y1="-4.5" x2="25.2" y2="11.8" stroke="#c8a050" stroke-width="0.55" opacity="0.44" stroke-linecap="round"/>
  <line x1="-2.5" y1="4.5" x2="-57.8" y2="35.8" stroke="#c8a050" stroke-width="0.55" opacity="0.55" stroke-linecap="round"/>
  <line x1="-2.5" y1="4.5" x2="24.0" y2="19.6" stroke="#c8a050" stroke-width="0.55" opacity="0.44" stroke-linecap="round"/>
  <line x1="-2.5" y1="13.6" x2="-55.7" y2="42.5" stroke="#c8a050" stroke-width="0.55" opacity="0.54" stroke-linecap="round"/>
  <line x1="-2.5" y1="13.6" x2="22.9" y2="27.4" stroke="#c8a050" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.4" y1="22.7" x2="-53.4" y2="49.3" stroke="#9a7030" stroke-width="0.55" opacity="0.53" stroke-linecap="round"/>
  <line x1="-2.4" y1="22.7" x2="21.7" y2="35.3" stroke="#9a7030" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.3" y1="31.8" x2="-50.9" y2="56.1" stroke="#9a7030" stroke-width="0.55" opacity="0.52" stroke-linecap="round"/>
  <line x1="-2.3" y1="31.8" x2="20.4" y2="43.2" stroke="#9a7030" stroke-width="0.55" opacity="0.42" stroke-linecap="round"/>
  <line x1="-2.2" y1="40.8" x2="-48.3" y2="62.9" stroke="#9a7030" stroke-width="0.55" opacity="0.51" stroke-linecap="round"/>
  <line x1="-2.2" y1="40.8" x2="19.2" y2="51.1" stroke="#9a7030" stroke-width="0.55" opacity="0.41" stroke-linecap="round"/>
  <line x1="-2.1" y1="49.9" x2="-45.5" y2="69.8" stroke="#9a7030" stroke-width="0.55" opacity="0.50" stroke-linecap="round"/>
  <line x1="-2.1" y1="49.9" x2="17.9" y2="59.1" stroke="#9a7030" stroke-width="0.55" opacity="0.40" stroke-linecap="round"/>
  <line x1="-2.0" y1="59.0" x2="-42.6" y2="76.8" stroke="#9a7030" stroke-width="0.55" opacity="0.48" stroke-linecap="round"/>
  <line x1="-2.0" y1="59.0" x2="16.5" y2="67.1" stroke="#9a7030" stroke-width="0.55" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.8" y1="68.1" x2="-39.4" y2="83.8" stroke="#9a7030" stroke-width="0.55" opacity="0.47" stroke-linecap="round"/>
  <line x1="-1.8" y1="68.1" x2="15.1" y2="75.2" stroke="#9a7030" stroke-width="0.55" opacity="0.37" stroke-linecap="round"/>
  <line x1="-1.6" y1="77.1" x2="-36.1" y2="90.9" stroke="#9a7030" stroke-width="0.55" opacity="0.45" stroke-linecap="round"/>
  <line x1="-1.6" y1="77.1" x2="13.7" y2="83.3" stroke="#9a7030" stroke-width="0.55" opacity="0.36" stroke-linecap="round"/>
  <line x1="-1.4" y1="86.2" x2="-32.5" y2="98.0" stroke="#9a7030" stroke-width="0.4" opacity="0.43" stroke-linecap="round"/>
  <line x1="-1.4" y1="86.2" x2="12.2" y2="91.4" stroke="#9a7030" stroke-width="0.4" opacity="0.34" stroke-linecap="round"/>
  <line x1="-1.2" y1="95.3" x2="-28.7" y2="105.2" stroke="#9a7030" stroke-width="0.4" opacity="0.41" stroke-linecap="round"/>
  <line x1="-1.2" y1="95.3" x2="10.6" y2="99.5" stroke="#9a7030" stroke-width="0.4" opacity="0.33" stroke-linecap="round"/>
  <line x1="-1.0" y1="104.4" x2="-24.6" y2="112.4" stroke="#9a7030" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.0" y1="104.4" x2="8.9" y2="107.8" stroke="#9a7030" stroke-width="0.4" opacity="0.31" stroke-linecap="round"/>
  <line x1="-0.7" y1="113.4" x2="-20.1" y2="119.7" stroke="#9a7030" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-0.7" y1="113.4" x2="7.1" y2="116.0" stroke="#9a7030" stroke-width="0.4" opacity="0.29" stroke-linecap="round"/>
  <line x1="-0.5" y1="122.5" x2="-15.0" y2="126.9" stroke="#9a7030" stroke-width="0.4" opacity="0.35" stroke-linecap="round"/>
  <line x1="-0.5" y1="122.5" x2="5.2" y2="124.2" stroke="#9a7030" stroke-width="0.4" opacity="0.28" stroke-linecap="round"/>
  <line x1="-0.2" y1="131.6" x2="-9.0" y2="134.1" stroke="#9a7030" stroke-width="0.4" opacity="0.32" stroke-linecap="round"/>
  <line x1="-0.2" y1="131.6" x2="2.9" y2="132.5" stroke="#9a7030" stroke-width="0.4" opacity="0.26" stroke-linecap="round"/>
  <path d="M 0,140.0 Q 1,172.5 1,205.0" fill="none" stroke="#c8a050" stroke-width="2.4" stroke-linecap="round"/>
  <path d="M 0,140.0 Q 0,172.5 0,205.0" fill="none" stroke="rgba(20,10,0,0.28)" stroke-width="0.7"/>
  <path d="M 1,205.0 Q 2.5,215.0 1.5,223.0 Q 0,228.0 -1.5,223.0 Q -2,215.0 0,205.0 Z" fill="#9a7030" fill-opacity="0.92"/>
  <line x1="0" y1="211.0" x2="0" y2="228.0" stroke="rgba(15,5,0,0.4)" stroke-width="0.5"/>
  </g>
</svg>

<!-- QUILL TR2 — medium, upper right -->
<svg class="quill-tr2" viewBox="0 0 160 380" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(80,185)">
  <path d="M 0,-108.0 L -0.0,-108.0 L -8.3,-96.0 L -16.6,-84.0 L -24.9,-72.0 L -33.2,-60.0 L -41.4,-48.0 L -49.5,-36.0 L -55.8,-24.0 L -52.5,-12.0 L -49.0,0.0 L -45.2,12.0 L -41.3,24.0 L -37.1,36.0 L -32.7,48.0 L -27.9,60.0 L -22.8,72.0 L -17.1,84.0 L -10.4,96.0 L -0.0,108.0 L 0,108.0 L -0.0,108.0 L 3.4,96.0 L 5.7,84.0 L 7.9,72.0 L 9.9,60.0 L 11.8,48.0 L 13.7,36.0 L 15.6,24.0 L 17.5,12.0 L 19.5,0.0 L 21.4,-12.0 L 23.4,-24.0 L 25.5,-36.0 L 22.5,-48.0 L 17.9,-60.0 L 13.4,-72.0 L 8.9,-84.0 L 4.4,-96.0 L 0.0,-108.0 Z" fill="#c0985a" fill-opacity="0.14" stroke="#c0985a" stroke-opacity="0.6" stroke-width="0.9" stroke-linejoin="round"/>
  <path d="M 0,-108.0 Q -5.0,0.0 1,108.0" fill="none" stroke="#c0985a" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="-0.2" y1="-101.5" x2="-3.5" y2="-98.3" stroke="#c0985a" stroke-width="0.4" opacity="0.32" stroke-linecap="round"/>
  <line x1="-0.2" y1="-101.5" x2="1.8" y2="-99.5" stroke="#c0985a" stroke-width="0.4" opacity="0.26" stroke-linecap="round"/>
  <line x1="-0.5" y1="-94.5" x2="-7.5" y2="-88.0" stroke="#c0985a" stroke-width="0.4" opacity="0.35" stroke-linecap="round"/>
  <line x1="-0.5" y1="-94.5" x2="3.9" y2="-90.4" stroke="#c0985a" stroke-width="0.4" opacity="0.28" stroke-linecap="round"/>
  <line x1="-0.7" y1="-87.5" x2="-11.5" y2="-77.7" stroke="#c0985a" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-0.7" y1="-87.5" x2="6.1" y2="-81.4" stroke="#c0985a" stroke-width="0.4" opacity="0.29" stroke-linecap="round"/>
  <line x1="-1.0" y1="-80.5" x2="-15.7" y2="-67.7" stroke="#c0985a" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.0" y1="-80.5" x2="8.3" y2="-72.4" stroke="#c0985a" stroke-width="0.4" opacity="0.31" stroke-linecap="round"/>
  <line x1="-1.2" y1="-73.5" x2="-19.9" y2="-57.7" stroke="#c0985a" stroke-width="0.4" opacity="0.41" stroke-linecap="round"/>
  <line x1="-1.2" y1="-73.5" x2="10.6" y2="-63.6" stroke="#c0985a" stroke-width="0.4" opacity="0.33" stroke-linecap="round"/>
  <line x1="-1.4" y1="-66.5" x2="-24.2" y2="-47.9" stroke="#c0985a" stroke-width="0.4" opacity="0.43" stroke-linecap="round"/>
  <line x1="-1.4" y1="-66.5" x2="12.9" y2="-54.8" stroke="#c0985a" stroke-width="0.4" opacity="0.34" stroke-linecap="round"/>
  <line x1="-1.6" y1="-59.5" x2="-28.7" y2="-38.2" stroke="#c0985a" stroke-width="0.4" opacity="0.45" stroke-linecap="round"/>
  <line x1="-1.6" y1="-59.5" x2="15.4" y2="-46.1" stroke="#c0985a" stroke-width="0.4" opacity="0.36" stroke-linecap="round"/>
  <line x1="-1.8" y1="-52.5" x2="-33.2" y2="-28.6" stroke="#c0985a" stroke-width="0.4" opacity="0.47" stroke-linecap="round"/>
  <line x1="-1.8" y1="-52.5" x2="17.9" y2="-37.5" stroke="#c0985a" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-2.0" y1="-45.5" x2="-37.7" y2="-19.2" stroke="#c0985a" stroke-width="0.4" opacity="0.48" stroke-linecap="round"/>
  <line x1="-2.0" y1="-45.5" x2="20.5" y2="-29.0" stroke="#c0985a" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-2.1" y1="-38.5" x2="-42.4" y2="-9.9" stroke="#c0985a" stroke-width="0.55" opacity="0.50" stroke-linecap="round"/>
  <line x1="-2.1" y1="-38.5" x2="23.0" y2="-20.7" stroke="#c0985a" stroke-width="0.55" opacity="0.40" stroke-linecap="round"/>
  <line x1="-2.2" y1="-31.5" x2="-47.1" y2="-0.8" stroke="#c0985a" stroke-width="0.55" opacity="0.51" stroke-linecap="round"/>
  <line x1="-2.2" y1="-31.5" x2="22.2" y2="-14.8" stroke="#c0985a" stroke-width="0.55" opacity="0.41" stroke-linecap="round"/>
  <line x1="-2.3" y1="-24.5" x2="-50.7" y2="7.4" stroke="#c0985a" stroke-width="0.55" opacity="0.52" stroke-linecap="round"/>
  <line x1="-2.3" y1="-24.5" x2="21.4" y2="-8.8" stroke="#c0985a" stroke-width="0.55" opacity="0.42" stroke-linecap="round"/>
  <line x1="-2.4" y1="-17.5" x2="-49.5" y2="12.4" stroke="#c0985a" stroke-width="0.55" opacity="0.53" stroke-linecap="round"/>
  <line x1="-2.4" y1="-17.5" x2="20.6" y2="-2.9" stroke="#c0985a" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.5" y1="-10.5" x2="-48.1" y2="17.4" stroke="#c0985a" stroke-width="0.55" opacity="0.54" stroke-linecap="round"/>
  <line x1="-2.5" y1="-10.5" x2="19.7" y2="3.1" stroke="#c0985a" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.5" y1="-3.5" x2="-46.7" y2="22.5" stroke="#c0985a" stroke-width="0.55" opacity="0.55" stroke-linecap="round"/>
  <line x1="-2.5" y1="-3.5" x2="18.9" y2="9.1" stroke="#c0985a" stroke-width="0.55" opacity="0.44" stroke-linecap="round"/>
  <line x1="-2.5" y1="3.5" x2="-45.2" y2="27.7" stroke="#c0985a" stroke-width="0.55" opacity="0.55" stroke-linecap="round"/>
  <line x1="-2.5" y1="3.5" x2="18.0" y2="15.1" stroke="#c0985a" stroke-width="0.55" opacity="0.44" stroke-linecap="round"/>
  <line x1="-2.5" y1="10.5" x2="-43.5" y2="32.8" stroke="#c0985a" stroke-width="0.55" opacity="0.54" stroke-linecap="round"/>
  <line x1="-2.5" y1="10.5" x2="17.1" y2="21.1" stroke="#c0985a" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.4" y1="17.5" x2="-41.7" y2="38.0" stroke="#906828" stroke-width="0.55" opacity="0.53" stroke-linecap="round"/>
  <line x1="-2.4" y1="17.5" x2="16.2" y2="27.2" stroke="#906828" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.3" y1="24.5" x2="-39.8" y2="43.3" stroke="#906828" stroke-width="0.55" opacity="0.52" stroke-linecap="round"/>
  <line x1="-2.3" y1="24.5" x2="15.2" y2="33.3" stroke="#906828" stroke-width="0.55" opacity="0.42" stroke-linecap="round"/>
  <line x1="-2.2" y1="31.5" x2="-37.8" y2="48.5" stroke="#906828" stroke-width="0.55" opacity="0.51" stroke-linecap="round"/>
  <line x1="-2.2" y1="31.5" x2="14.3" y2="39.4" stroke="#906828" stroke-width="0.55" opacity="0.41" stroke-linecap="round"/>
  <line x1="-2.1" y1="38.5" x2="-35.6" y2="53.9" stroke="#906828" stroke-width="0.55" opacity="0.50" stroke-linecap="round"/>
  <line x1="-2.1" y1="38.5" x2="13.3" y2="45.6" stroke="#906828" stroke-width="0.55" opacity="0.40" stroke-linecap="round"/>
  <line x1="-2.0" y1="45.5" x2="-33.3" y2="59.2" stroke="#906828" stroke-width="0.55" opacity="0.48" stroke-linecap="round"/>
  <line x1="-2.0" y1="45.5" x2="12.3" y2="51.8" stroke="#906828" stroke-width="0.55" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.8" y1="52.5" x2="-30.8" y2="64.7" stroke="#906828" stroke-width="0.55" opacity="0.47" stroke-linecap="round"/>
  <line x1="-1.8" y1="52.5" x2="11.3" y2="58.0" stroke="#906828" stroke-width="0.55" opacity="0.37" stroke-linecap="round"/>
  <line x1="-1.6" y1="59.5" x2="-28.2" y2="70.1" stroke="#906828" stroke-width="0.55" opacity="0.45" stroke-linecap="round"/>
  <line x1="-1.6" y1="59.5" x2="10.2" y2="64.2" stroke="#906828" stroke-width="0.55" opacity="0.36" stroke-linecap="round"/>
  <line x1="-1.4" y1="66.5" x2="-25.4" y2="75.6" stroke="#906828" stroke-width="0.4" opacity="0.43" stroke-linecap="round"/>
  <line x1="-1.4" y1="66.5" x2="9.1" y2="70.5" stroke="#906828" stroke-width="0.4" opacity="0.34" stroke-linecap="round"/>
  <line x1="-1.2" y1="73.5" x2="-22.4" y2="81.2" stroke="#906828" stroke-width="0.4" opacity="0.41" stroke-linecap="round"/>
  <line x1="-1.2" y1="73.5" x2="7.9" y2="76.8" stroke="#906828" stroke-width="0.4" opacity="0.33" stroke-linecap="round"/>
  <line x1="-1.0" y1="80.5" x2="-19.2" y2="86.7" stroke="#906828" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.0" y1="80.5" x2="6.7" y2="83.1" stroke="#906828" stroke-width="0.4" opacity="0.31" stroke-linecap="round"/>
  <line x1="-0.7" y1="87.5" x2="-15.6" y2="92.3" stroke="#906828" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-0.7" y1="87.5" x2="5.3" y2="89.5" stroke="#906828" stroke-width="0.4" opacity="0.29" stroke-linecap="round"/>
  <line x1="-0.5" y1="94.5" x2="-11.7" y2="97.9" stroke="#906828" stroke-width="0.4" opacity="0.35" stroke-linecap="round"/>
  <line x1="-0.5" y1="94.5" x2="3.9" y2="95.8" stroke="#906828" stroke-width="0.4" opacity="0.28" stroke-linecap="round"/>
  <line x1="-0.2" y1="101.5" x2="-7.0" y2="103.4" stroke="#906828" stroke-width="0.4" opacity="0.32" stroke-linecap="round"/>
  <line x1="-0.2" y1="101.5" x2="2.2" y2="102.2" stroke="#906828" stroke-width="0.4" opacity="0.26" stroke-linecap="round"/>
  <path d="M 0,108.0 Q 1,134.0 1,160.0" fill="none" stroke="#c0985a" stroke-width="2.4" stroke-linecap="round"/>
  <path d="M 0,108.0 Q 0,134.0 0,160.0" fill="none" stroke="rgba(20,10,0,0.28)" stroke-width="0.7"/>
  <path d="M 1,160.0 Q 2.5,170.0 1.5,178.0 Q 0,183.0 -1.5,178.0 Q -2,170.0 0,160.0 Z" fill="#906828" fill-opacity="0.92"/>
  <line x1="0" y1="166.0" x2="0" y2="183.0" stroke="rgba(15,5,0,0.4)" stroke-width="0.5"/>
  </g>
</svg>

<!-- QUILL TL2 — small, upper left -->
<svg class="quill-tl2" viewBox="0 0 120 300" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(60,148)">
  <path d="M 0,-85.0 L -0.0,-85.0 L -6.6,-75.6 L -13.3,-66.1 L -19.9,-56.7 L -26.5,-47.2 L -33.0,-37.8 L -39.4,-28.3 L -44.4,-18.9 L -41.8,-9.4 L -39.1,0.0 L -36.1,9.4 L -33.0,18.9 L -29.7,28.3 L -26.1,37.8 L -22.3,47.2 L -18.2,56.7 L -13.6,66.1 L -8.3,75.6 L -0.0,85.0 L 0,85.0 L -0.0,85.0 L 2.5,75.6 L 4.3,66.1 L 5.9,56.7 L 7.4,47.2 L 8.9,37.8 L 10.3,28.3 L 11.8,18.9 L 13.3,9.4 L 14.8,0.0 L 16.3,-9.4 L 17.9,-18.9 L 19.6,-28.3 L 17.3,-37.8 L 13.7,-47.2 L 10.3,-56.7 L 6.8,-66.1 L 3.4,-75.6 L 0.0,-85.0 Z" fill="#b89050" fill-opacity="0.14" stroke="#b89050" stroke-opacity="0.6" stroke-width="0.9" stroke-linejoin="round"/>
  <path d="M 0,-85.0 Q -5.0,0.0 1,85.0" fill="none" stroke="#b89050" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="-0.2" y1="-79.9" x2="-2.8" y2="-77.4" stroke="#b89050" stroke-width="0.4" opacity="0.32" stroke-linecap="round"/>
  <line x1="-0.2" y1="-79.9" x2="1.4" y2="-78.3" stroke="#b89050" stroke-width="0.4" opacity="0.26" stroke-linecap="round"/>
  <line x1="-0.5" y1="-74.4" x2="-6.0" y2="-69.2" stroke="#b89050" stroke-width="0.4" opacity="0.35" stroke-linecap="round"/>
  <line x1="-0.5" y1="-74.4" x2="3.0" y2="-71.1" stroke="#b89050" stroke-width="0.4" opacity="0.28" stroke-linecap="round"/>
  <line x1="-0.7" y1="-68.9" x2="-9.2" y2="-61.2" stroke="#b89050" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-0.7" y1="-68.9" x2="4.6" y2="-64.0" stroke="#b89050" stroke-width="0.4" opacity="0.29" stroke-linecap="round"/>
  <line x1="-1.0" y1="-63.4" x2="-12.5" y2="-53.2" stroke="#b89050" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.0" y1="-63.4" x2="6.3" y2="-57.0" stroke="#b89050" stroke-width="0.4" opacity="0.31" stroke-linecap="round"/>
  <line x1="-1.2" y1="-57.9" x2="-15.9" y2="-45.4" stroke="#b89050" stroke-width="0.4" opacity="0.41" stroke-linecap="round"/>
  <line x1="-1.2" y1="-57.9" x2="8.1" y2="-50.0" stroke="#b89050" stroke-width="0.4" opacity="0.33" stroke-linecap="round"/>
  <line x1="-1.4" y1="-52.3" x2="-19.4" y2="-37.7" stroke="#b89050" stroke-width="0.4" opacity="0.43" stroke-linecap="round"/>
  <line x1="-1.4" y1="-52.3" x2="9.9" y2="-43.1" stroke="#b89050" stroke-width="0.4" opacity="0.34" stroke-linecap="round"/>
  <line x1="-1.6" y1="-46.8" x2="-22.9" y2="-30.0" stroke="#b89050" stroke-width="0.4" opacity="0.45" stroke-linecap="round"/>
  <line x1="-1.6" y1="-46.8" x2="11.8" y2="-36.3" stroke="#b89050" stroke-width="0.4" opacity="0.36" stroke-linecap="round"/>
  <line x1="-1.8" y1="-41.3" x2="-26.5" y2="-22.5" stroke="#b89050" stroke-width="0.4" opacity="0.47" stroke-linecap="round"/>
  <line x1="-1.8" y1="-41.3" x2="13.7" y2="-29.5" stroke="#b89050" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-2.0" y1="-35.8" x2="-30.1" y2="-15.1" stroke="#b89050" stroke-width="0.4" opacity="0.48" stroke-linecap="round"/>
  <line x1="-2.0" y1="-35.8" x2="15.7" y2="-22.8" stroke="#b89050" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-2.1" y1="-30.3" x2="-33.8" y2="-7.8" stroke="#b89050" stroke-width="0.55" opacity="0.50" stroke-linecap="round"/>
  <line x1="-2.1" y1="-30.3" x2="17.7" y2="-16.3" stroke="#b89050" stroke-width="0.55" opacity="0.40" stroke-linecap="round"/>
  <line x1="-2.2" y1="-24.8" x2="-37.5" y2="-0.6" stroke="#b89050" stroke-width="0.55" opacity="0.51" stroke-linecap="round"/>
  <line x1="-2.2" y1="-24.8" x2="17.0" y2="-11.6" stroke="#b89050" stroke-width="0.55" opacity="0.41" stroke-linecap="round"/>
  <line x1="-2.3" y1="-19.3" x2="-40.4" y2="5.8" stroke="#b89050" stroke-width="0.55" opacity="0.52" stroke-linecap="round"/>
  <line x1="-2.3" y1="-19.3" x2="16.3" y2="-7.0" stroke="#b89050" stroke-width="0.55" opacity="0.42" stroke-linecap="round"/>
  <line x1="-2.4" y1="-13.8" x2="-39.4" y2="9.7" stroke="#b89050" stroke-width="0.55" opacity="0.53" stroke-linecap="round"/>
  <line x1="-2.4" y1="-13.8" x2="15.7" y2="-2.3" stroke="#b89050" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.5" y1="-8.3" x2="-38.4" y2="13.7" stroke="#b89050" stroke-width="0.55" opacity="0.54" stroke-linecap="round"/>
  <line x1="-2.5" y1="-8.3" x2="15.0" y2="2.4" stroke="#b89050" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.5" y1="-2.8" x2="-37.3" y2="17.7" stroke="#b89050" stroke-width="0.55" opacity="0.55" stroke-linecap="round"/>
  <line x1="-2.5" y1="-2.8" x2="14.3" y2="7.1" stroke="#b89050" stroke-width="0.55" opacity="0.44" stroke-linecap="round"/>
  <line x1="-2.5" y1="2.8" x2="-36.1" y2="21.8" stroke="#b89050" stroke-width="0.55" opacity="0.55" stroke-linecap="round"/>
  <line x1="-2.5" y1="2.8" x2="13.6" y2="11.9" stroke="#b89050" stroke-width="0.55" opacity="0.44" stroke-linecap="round"/>
  <line x1="-2.5" y1="8.3" x2="-34.8" y2="25.8" stroke="#b89050" stroke-width="0.55" opacity="0.54" stroke-linecap="round"/>
  <line x1="-2.5" y1="8.3" x2="12.9" y2="16.6" stroke="#b89050" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.4" y1="13.8" x2="-33.3" y2="29.9" stroke="#887020" stroke-width="0.55" opacity="0.53" stroke-linecap="round"/>
  <line x1="-2.4" y1="13.8" x2="12.2" y2="21.4" stroke="#887020" stroke-width="0.55" opacity="0.43" stroke-linecap="round"/>
  <line x1="-2.3" y1="19.3" x2="-31.8" y2="34.0" stroke="#887020" stroke-width="0.55" opacity="0.52" stroke-linecap="round"/>
  <line x1="-2.3" y1="19.3" x2="11.5" y2="26.2" stroke="#887020" stroke-width="0.55" opacity="0.42" stroke-linecap="round"/>
  <line x1="-2.2" y1="24.8" x2="-30.2" y2="38.2" stroke="#887020" stroke-width="0.55" opacity="0.51" stroke-linecap="round"/>
  <line x1="-2.2" y1="24.8" x2="10.8" y2="31.0" stroke="#887020" stroke-width="0.55" opacity="0.41" stroke-linecap="round"/>
  <line x1="-2.1" y1="30.3" x2="-28.5" y2="42.4" stroke="#887020" stroke-width="0.55" opacity="0.50" stroke-linecap="round"/>
  <line x1="-2.1" y1="30.3" x2="10.0" y2="35.9" stroke="#887020" stroke-width="0.55" opacity="0.40" stroke-linecap="round"/>
  <line x1="-2.0" y1="35.8" x2="-26.6" y2="46.6" stroke="#887020" stroke-width="0.55" opacity="0.48" stroke-linecap="round"/>
  <line x1="-2.0" y1="35.8" x2="9.3" y2="40.7" stroke="#887020" stroke-width="0.55" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.8" y1="41.3" x2="-24.7" y2="50.9" stroke="#887020" stroke-width="0.55" opacity="0.47" stroke-linecap="round"/>
  <line x1="-1.8" y1="41.3" x2="8.5" y2="45.6" stroke="#887020" stroke-width="0.55" opacity="0.37" stroke-linecap="round"/>
  <line x1="-1.6" y1="46.8" x2="-22.6" y2="55.2" stroke="#887020" stroke-width="0.55" opacity="0.45" stroke-linecap="round"/>
  <line x1="-1.6" y1="46.8" x2="7.7" y2="50.5" stroke="#887020" stroke-width="0.55" opacity="0.36" stroke-linecap="round"/>
  <line x1="-1.4" y1="52.3" x2="-20.3" y2="59.5" stroke="#887020" stroke-width="0.4" opacity="0.43" stroke-linecap="round"/>
  <line x1="-1.4" y1="52.3" x2="6.8" y2="55.5" stroke="#887020" stroke-width="0.4" opacity="0.34" stroke-linecap="round"/>
  <line x1="-1.2" y1="57.9" x2="-17.9" y2="63.9" stroke="#887020" stroke-width="0.4" opacity="0.41" stroke-linecap="round"/>
  <line x1="-1.2" y1="57.9" x2="6.0" y2="60.4" stroke="#887020" stroke-width="0.4" opacity="0.33" stroke-linecap="round"/>
  <line x1="-1.0" y1="63.4" x2="-15.3" y2="68.3" stroke="#887020" stroke-width="0.4" opacity="0.39" stroke-linecap="round"/>
  <line x1="-1.0" y1="63.4" x2="5.0" y2="65.4" stroke="#887020" stroke-width="0.4" opacity="0.31" stroke-linecap="round"/>
  <line x1="-0.7" y1="68.9" x2="-12.5" y2="72.7" stroke="#887020" stroke-width="0.4" opacity="0.37" stroke-linecap="round"/>
  <line x1="-0.7" y1="68.9" x2="4.1" y2="70.4" stroke="#887020" stroke-width="0.4" opacity="0.29" stroke-linecap="round"/>
  <line x1="-0.5" y1="74.4" x2="-9.3" y2="77.1" stroke="#887020" stroke-width="0.4" opacity="0.35" stroke-linecap="round"/>
  <line x1="-0.5" y1="74.4" x2="3.0" y2="75.4" stroke="#887020" stroke-width="0.4" opacity="0.28" stroke-linecap="round"/>
  <line x1="-0.2" y1="79.9" x2="-5.5" y2="81.4" stroke="#887020" stroke-width="0.4" opacity="0.32" stroke-linecap="round"/>
  <line x1="-0.2" y1="79.9" x2="1.7" y2="80.4" stroke="#887020" stroke-width="0.4" opacity="0.26" stroke-linecap="round"/>
  <path d="M 0,85.0 Q 1,105.0 1,125.0" fill="none" stroke="#b89050" stroke-width="2.4" stroke-linecap="round"/>
  <path d="M 0,85.0 Q 0,105.0 0,125.0" fill="none" stroke="rgba(20,10,0,0.28)" stroke-width="0.7"/>
  <path d="M 1,125.0 Q 2.5,135.0 1.5,143.0 Q 0,148.0 -1.5,143.0 Q -2,135.0 0,125.0 Z" fill="#887020" fill-opacity="0.92"/>
  <line x1="0" y1="131.0" x2="0" y2="148.0" stroke="rgba(15,5,0,0.4)" stroke-width="0.5"/>
  </g>
</svg>

<!-- HEADER -->
<header>
  <div class="logo">The Letter Jar ✦</div>

  <!-- JAR SELECTOR -->
  <div class="jar-selector-wrap" id="jarSelectorWrap">
    <button class="jar-selector-btn" onclick="toggleJarDropdown(event)">
      <span class="jar-name-display" id="jarNameDisplay">Loading…</span>
      <span class="chevron">▾</span>
    </button>
    <div class="jar-dropdown" id="jarDropdown">
      <div class="jar-dropdown-scroll" id="jarDropdownList"></div>
      <div class="jar-dropdown-footer">
        <button class="create-jar-btn" onclick="openCreateJar()">✦ Create a new jar</button>
      </div>
    </div>
  </div>

  <nav>
    <a onclick="openModal()">Write a Letter</a>
    <a onclick="openCreateJar()">New Jar</a>
  </nav>
</header>

<!-- HERO -->
<main class="hero">

  <!-- LEFT -->
  <div class="hero-left">
    <div class="eyebrow">A collection of words</div>
    <h1 class="hero-title">
      Leave a note,<br>
      <em>fill the jar</em>
    </h1>
    <p class="hero-desc">Every letter carries a piece of you. Write something tender, something true — fold it up and drop it in for someone to find.</p>
    <div class="cta-group">
      <button class="btn-primary" onclick="openModal()">Write your letter</button>
      <button class="btn-ghost" onclick="scrollJar()">Read the jar</button>
    </div>

    <!-- Current jar context -->
    <div class="jar-context">
      <div class="jar-context-label">Currently viewing</div>
      <div class="jar-context-name" id="jarContextName">—</div>
      <div class="jar-context-count" id="jarContextCount"></div>
    </div>
  </div>

  <!-- JAR -->
  <div class="jar-col">
    <div class="jar-glow"></div>
    <div class="jar-scene">
      <div class="letter-badge" id="letterBadge">0</div>
      <svg class="jar-svg" viewBox="0 0 280 390" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Clip to jar shape so highlights never bleed outside -->
          <clipPath id="jarClip">
            <path d="M62,104 Q56,112 50,130 L38,338 Q36,364 140,367 Q244,364 242,338 L230,130 Q224,112 218,104 Z"/>
          </clipPath>
          <!-- Glass body tint -->
          <linearGradient id="glassBody" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="#b0ccd8" stop-opacity="0.20"/>
            <stop offset="10%"  stop-color="#d8eaf2" stop-opacity="0.06"/>
            <stop offset="50%"  stop-color="#eef6fa" stop-opacity="0.02"/>
            <stop offset="88%"  stop-color="#c0d8e8" stop-opacity="0.08"/>
            <stop offset="100%" stop-color="#80a8c0" stop-opacity="0.20"/>
          </linearGradient>
          <!-- Left shine: white fading right -->
          <linearGradient id="shineL" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="rgba(255,255,255,0.52)"/>
            <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
          </linearGradient>
          <!-- Right shadow: transparent to dark -->
          <linearGradient id="shadowR" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="rgba(0,0,0,0)"/>
            <stop offset="100%" stop-color="rgba(18,10,3,0.24)"/>
          </linearGradient>
          <!-- Lid -->
          <linearGradient id="lidRed" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#b08858"/><stop offset="42%" stop-color="#8a6840"/>
            <stop offset="100%" stop-color="#6a4828"/>
          </linearGradient>
          <linearGradient id="lidBand" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#c09a68"/><stop offset="100%" stop-color="#7a5838"/>
          </linearGradient>
          <!-- Small jar (unused but kept for safety) -->
          <linearGradient id="jarFillSmall" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="#b0ccd8" stop-opacity="0.18"/>
            <stop offset="50%"  stop-color="#eef6fa" stop-opacity="0.02"/>
            <stop offset="100%" stop-color="#80a8c0" stop-opacity="0.18"/>
          </linearGradient>
          <linearGradient id="lidRedSmall" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#b08858"/><stop offset="100%" stop-color="#6a4828"/>
          </linearGradient>
        </defs>

        <!-- Drop shadow -->
        <ellipse cx="140" cy="365" rx="100" ry="7" fill="rgba(0,0,0,0.28)"/>

        <!-- Glass tint fill -->
        <path d="M62,104 Q56,112 50,130 L38,338 Q36,364 140,367 Q244,364 242,338 L230,130 Q224,112 218,104 Z"
              fill="url(#glassBody)"/>

        <!-- Left highlight — clipped inside jar -->
        <rect x="38" y="104" width="40" height="264" fill="url(#shineL)" clip-path="url(#jarClip)"/>
        <!-- Thin bright inner edge -->
        <rect x="38" y="104" width="14" height="264" fill="rgba(255,255,255,0.18)" clip-path="url(#jarClip)"/>

        <!-- Right shadow — clipped inside jar -->
        <rect x="202" y="104" width="42" height="264" fill="url(#shadowR)" clip-path="url(#jarClip)"/>

        <!-- Faint horizontal refraction band -->
        <rect x="38" y="188" width="204" height="18" fill="rgba(255,255,255,0.035)" clip-path="url(#jarClip)"/>

        <!-- Warm inner base glow (contents colour) -->
        <ellipse cx="140" cy="352" rx="96" ry="12" fill="rgba(185,150,95,0.07)" clip-path="url(#jarClip)"/>

        <!-- Jar outline -->
        <path d="M62,104 Q56,112 50,130 L38,338 Q36,364 140,367 Q244,364 242,338 L230,130 Q224,112 218,104 Z"
              fill="none" stroke="rgba(210,232,248,0.62)" stroke-width="1.5"/>

        <!-- Label -->
        <rect x="90" y="200" width="100" height="72" rx="3"
              fill="rgba(255,255,255,0.025)" stroke="rgba(215,188,142,0.28)" stroke-width="1" stroke-dasharray="3,3"/>
        <text x="140" y="228" text-anchor="middle" font-family="Playfair Display, serif" font-style="italic" font-size="10" fill="rgba(228,198,148,0.6)">Letters</text>
        <text x="140" y="244" text-anchor="middle" font-family="Cormorant Garamond, serif" font-size="8" fill="rgba(228,198,148,0.46)">— with love —</text>
        <text x="140" y="260" text-anchor="middle" font-size="9" fill="rgba(228,198,148,0.4)">✦</text>

        <!-- Rim -->
        <ellipse cx="140" cy="104" rx="78" ry="8"
                 fill="rgba(215,235,248,0.1)" stroke="rgba(210,232,248,0.68)" stroke-width="1.5"/>
        <path d="M82,101 Q140,96 198,101"
              fill="none" stroke="rgba(255,255,255,0.58)" stroke-width="2" stroke-linecap="round"/>

        <!-- Lid band -->
        <rect x="60" y="86" width="160" height="22" rx="5" fill="url(#lidBand)" stroke="rgba(215,172,108,0.55)" stroke-width="1"/>
        <path d="M66,89 Q140,85 214,89" fill="none" stroke="rgba(255,232,178,0.3)" stroke-width="2" stroke-linecap="round"/>

        <!-- Lid top -->
        <rect x="70" y="64" width="140" height="26" rx="9" fill="url(#lidRed)" stroke="rgba(215,172,108,0.6)" stroke-width="1"/>
        <rect x="86" y="68" width="82" height="6" rx="3" fill="rgba(255,238,188,0.3)"/>
        <ellipse cx="140" cy="64" rx="18" ry="4" fill="rgba(155,115,58,0.55)" stroke="rgba(215,172,108,0.45)" stroke-width="0.8"/>
      </svg>
      <div class="jar-letters" id="jarLetters">
        <div class="empty-hint" id="emptyHint">no letters yet…<br>be the first</div>
      </div>
    </div>

    <button class="env-cta" onclick="openModal()">
      <svg class="env-icon" id="envCTAIcon" viewBox="0 0 60 44" xmlns="http://www.w3.org/2000/svg">
        <!-- Small open book icon -->
        <path d="M30,6 Q12,3 4,10 L4,38 Q12,33 30,36 Z" fill="rgba(140,100,45,0.3)" stroke="rgba(180,140,70,0.7)" stroke-width="1.2"/>
        <path d="M30,6 Q48,3 56,10 L56,38 Q48,33 30,36 Z" fill="rgba(120,85,35,0.3)" stroke="rgba(180,140,70,0.7)" stroke-width="1.2"/>
        <line x1="30" y1="6" x2="30" y2="36" stroke="rgba(180,140,70,0.9)" stroke-width="1.4"/>
        <line x1="9" y1="16" x2="26" y2="14" stroke="rgba(180,140,70,0.45)" stroke-width="0.8" stroke-linecap="round"/>
        <line x1="9" y1="22" x2="25" y2="20" stroke="rgba(180,140,70,0.45)" stroke-width="0.8" stroke-linecap="round"/>
        <line x1="34" y1="16" x2="51" y2="14" stroke="rgba(180,140,70,0.45)" stroke-width="0.8" stroke-linecap="round"/>
        <line x1="34" y1="22" x2="51" y2="20" stroke="rgba(180,140,70,0.45)" stroke-width="0.8" stroke-linecap="round"/>
        <circle cx="30" cy="25" r="4.5" fill="rgba(140,100,45,0.8)" stroke="rgba(180,140,70,0.45)" stroke-width="1"/>
        <text x="30" y="28.5" text-anchor="middle" font-size="5" fill="rgba(245,238,220,0.9)">✦</text>
      </svg>
      drop a letter in
    </button>

  </div>

  <!-- RIGHT: PANEL -->
  <div class="hero-right">
    <div class="recent-title" id="panelTitle">Letters</div>
    <div class="panel-tabs">
      <button class="panel-tab" onclick="switchTab('All')" id="tabAll">All <span class="tab-badge hidden" id="unreadBadge">0</span></button>
      <button class="panel-tab active" onclick="switchTab('Unread')" id="tabUnread">Unread <span class="tab-badge hidden" id="unreadBadge2">0</span></button>
    </div>
    <div class="tab-pane" id="paneAll">
      <p class="no-letters-hint" id="noLettersHint">The jar awaits its first<br>folded secret…</p>
    </div>
    <div class="tab-pane active" id="paneUnread">
      <p class="no-letters-hint" id="noUnreadHint">You've read everything<br>in the jar ✦</p>
    </div>
  </div>

</main>

<footer>The Letter Jar &nbsp;✦&nbsp; Every word belongs here</footer>

<!-- WRITE MODAL -->
<div class="overlay" id="overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <svg class="modal-book" viewBox="0 0 110 100" xmlns="http://www.w3.org/2000/svg">
      <!-- Small open book decoration -->
      <path d="M55,15 Q30,12 10,22 L10,80 Q30,72 55,76 Z" fill="#fdf0d0" stroke="#c8a060" stroke-width="0.8" opacity="0.7"/>
      <path d="M55,15 Q80,12 100,22 L100,80 Q80,72 55,76 Z" fill="#f8e8c8" stroke="#c8a060" stroke-width="0.8" opacity="0.7"/>
      <line x1="55" y1="15" x2="55" y2="76" stroke="#b08858" stroke-width="1.2" opacity="0.8"/>
      <line x1="18" y1="34" x2="48" y2="31" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.3"/>
      <line x1="18" y1="43" x2="46" y2="40" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.3"/>
      <line x1="18" y1="52" x2="48" y2="49" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.3"/>
      <line x1="62" y1="34" x2="92" y2="31" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.3"/>
      <line x1="62" y1="43" x2="94" y2="40" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.3"/>
      <line x1="62" y1="52" x2="90" y2="49" stroke="#c09060" stroke-width="0.6" stroke-linecap="round" opacity="0.3"/>
      <text x="55" y="71" text-anchor="middle" font-size="7" fill="rgba(200,155,90,0.45)">✦</text>
    </svg>
    <div class="modal-title">Write your letter</div>
    <p class="modal-sub">A note, a memory, a secret — fold it and let it rest.</p>
    <div class="divider"></div>
    <div class="color-picker-row">
      <span class="color-picker-label">Envelope</span>
      <div class="swatch selected" data-color="#c8192a" style="background:#c8192a" onclick="selectColor(this)" title="Crimson"></div>
      <div class="swatch" data-color="#c8a050" style="background:#c8a050" onclick="selectColor(this)" title="Antique Gold"></div>
      <div class="swatch" data-color="#3a6bc8" style="background:#3a6bc8" onclick="selectColor(this)" title="Midnight Blue"></div>
      <div class="swatch" data-color="#3a8050" style="background:#3a8050" onclick="selectColor(this)" title="Forest Green"></div>
      <div class="swatch" data-color="#9a2a8a" style="background:#9a2a8a" onclick="selectColor(this)" title="Plum"></div>
      <div class="swatch" data-color="#a08060" style="background:#a08060" onclick="selectColor(this)" title="Aged Bone"></div>
    </div>
    <label for="fromField">From</label>
    <input type="text" id="fromField" placeholder="Your name, or stay a mystery…" maxlength="60"/>
    <label for="letterBody">Your letter</label>
    <textarea id="letterBody" rows="6" placeholder="Write whatever your heart holds…"></textarea>
    <div class="modal-actions">
      <button class="btn-cancel-modal" onclick="closeModal()">Cancel</button>
      <button class="btn-submit-modal" onclick="submitLetter()">Drop it in ✦</button>
    </div>
  </div>
</div>

<!-- CREATE JAR MODAL -->
<div class="overlay" id="createJarOverlay" onclick="handleCreateJarClick(event)">
  <div class="modal create-jar-modal">
    <div class="modal-title">Name your jar</div>
    <p class="modal-sub">Create a private space for letters to collect.</p>
    <div class="divider"></div>
    <label for="jarNameInput">Jar name</label>
    <input type="text" id="jarNameInput" placeholder="e.g. Letters to the future…" maxlength="50"/>
    <label for="jarDescInput">Description <span style="opacity:0.4;font-style:italic;font-size:0.8em;">(optional)</span></label>
    <input type="text" id="jarDescInput" placeholder="What is this jar for?" maxlength="100"/>
    <div class="modal-actions">
      <button class="btn-cancel-modal" onclick="closeCreateJar()">Cancel</button>
      <button class="btn-submit-modal" onclick="createJar()">Create jar ✦</button>
    </div>
  </div>
</div>

<!-- DELETE JAR MODAL -->
<div class="overlay" id="deleteJarOverlay" onclick="handleDeleteJarClick(event)">
  <div class="modal create-jar-modal">
    <div class="modal-title">Delete this jar?</div>
    <p class="confirm-text">This will permanently erase <span class="confirm-name" id="deleteJarNameDisplay"></span> and all <span id="deleteJarCountDisplay">0</span> letters inside. This cannot be undone.</p>
    <div class="modal-actions">
      <button class="btn-cancel-modal" onclick="closeDeleteJar()">Cancel</button>
      <button class="btn-danger" onclick="confirmDeleteJar()">Delete forever</button>
    </div>
  </div>
</div>

<!-- READ LETTER MODAL -->
<div class="read-overlay" id="readOverlay" onclick="handleReadClick(event)">
  <div class="read-modal" id="readModal">
    <button class="read-close" onclick="closeRead()">×</button>
    <div class="read-env-stripe" id="readEnvStripe"></div>
    <div class="read-from" id="readFrom"></div>
    <div class="read-divider"></div>
    <div class="read-body" id="readBody"></div>
    <!-- Heart button (bottom left) -->
    <div class="read-heart-wrap">
      <button class="read-heart-btn" id="readHeartBtn" onclick="toggleHeart(currentReadId, event)" title="Heart this letter">
        <svg viewBox="0 0 34 34" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 27s-10-6.3-10-13a7 7 0 0 1 10-6.05A7 7 0 0 1 27 14c0 6.7-10 13-10 13z" fill="none" stroke="#e05060" stroke-width="1.6" stroke-linejoin="round"/>
        </svg>
        <span class="read-heart-count" id="readHeartCount"></span>
      </button>
      <span class="read-wax-label">heart</span>
    </div>
    <div class="read-wax-wrap" id="readWaxWrap">
      <div class="read-delete-confirm" id="readDeleteConfirm">        <span class="read-delete-confirm-text">Delete this letter?</span>
        <div class="read-delete-confirm-btns">
          <button class="rdc-btn rdc-cancel" onclick="cancelDeleteLetter()">No</button>
          <button class="rdc-btn rdc-confirm" onclick="confirmDeleteLetter()">Yes, delete</button>
        </div>
      </div>
      <svg class="read-wax" viewBox="0 0 34 34" xmlns="http://www.w3.org/2000/svg" id="readWax" onclick="promptDeleteLetter()" title="Delete this letter">
        <circle cx="17" cy="17" r="15" fill="rgba(70,45,15,0.7)"/>
        <circle cx="17" cy="17" r="12" fill="none" stroke="rgba(180,140,70,0.38)" stroke-width="0.8"/>
        <text x="17" y="21" text-anchor="middle" font-size="10" fill="rgba(245,225,195,0.7)">✦</text>
        <title>Delete letter</title>
      </svg>
      <span class="read-wax-label">delete</span>
    </div>
  </div>
</div>

<!-- READ JAR LIST MODAL -->
<div class="read-overlay" id="rjOverlay" onclick="handleRjClick(event)">
  <div class="rj-modal">
    <button class="read-close" onclick="closeRjModal()">×</button>
    <div class="rj-modal-title">Your Read Letters</div>
    <p class="rj-modal-sub">Letters you've already unfolded ✦</p>
    <div id="rjModalList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="shared-banner" id="sharedBanner" style="opacity:0"></div>

<script>
// ═══════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════
let jars = [];           // [{id, name, desc, createdAt}]
let currentJarId = null;
let letters = [];        // letters for currentJar
let readIds = new Set(); // letter IDs read in currentJar this session
let heartIds = new Set(); // letter IDs hearted by this session (personal)
let sessionId = '';
let selectedColor = '#c8192a';
let pendingDeleteJarId = null;
let pollTimer = null;

// ═══════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════
async function init() {
  // Session ID
  try {
    const s = await storage.get('sid');
    sessionId = s ? s.value : genId('sid');
    if (!s) await storage.set('sid', sessionId);
  } catch { sessionId = genId('sid'); try { await storage.set('sid', sessionId); } catch {} }

  // Load jars list
  await loadJarsList();

  // Pick last used jar or first available
  try {
    const last = await storage.get('last-jar:' + sessionId);
    if (last && jars.find(j => j.id === last.value)) {
      currentJarId = last.value;
    }
  } catch {}

  if (!currentJarId && jars.length > 0) currentJarId = jars[0].id;

  // If no jars exist, create the default
  if (jars.length === 0) {
    await createDefaultJar();
  }

  await switchToJar(currentJarId, false);
  startPolling();
}

async function loadJarsList() {
  try {
    const r = await storage.get('jars', true);
    jars = r ? JSON.parse(r.value) : [];
  } catch { jars = []; }
}

async function saveJarsList() {
  try { await storage.set('jars', JSON.stringify(jars), true); } catch {}
}

async function createDefaultJar() {
  const jar = { id: genId('jar'), name: 'The Letter Jar', desc: 'A place for all letters', createdAt: Date.now() };
  jars.push(jar);
  await saveJarsList();
  currentJarId = jar.id;
}

// ═══════════════════════════════════════════
//  JAR SWITCHING
// ═══════════════════════════════════════════
async function switchToJar(jarId, animate) {
  currentJarId = jarId;
  try { await storage.set('last-jar:' + sessionId, jarId); } catch {}

  // Load letters for this jar
  await loadLetters();

  // Load read IDs for this session + jar
  readIds = new Set();
  try {
    const r = await storage.get('rids:' + sessionId + ':' + jarId);
    if (r) readIds = new Set(JSON.parse(r.value));
  } catch {}

  // Load heart IDs for this session + jar
  heartIds = new Set();
  try {
    const h = await storage.get('hids:' + sessionId + ':' + jarId);
    if (h) heartIds = new Set(JSON.parse(h.value));
  } catch {}

  renderAll(animate !== false);
  renderJarDropdown();
  updateJarContext();
}

async function loadLetters() {
  try {
    const r = await storage.get('letters:' + currentJarId, true);
    letters = r ? JSON.parse(r.value) : [];
  } catch { letters = []; }
}

async function saveLetters() {
  try { await storage.set('letters:' + currentJarId, JSON.stringify(letters), true); } catch {}
}

async function saveReadIds() {
  try { await storage.set('rids:' + sessionId + ':' + currentJarId, JSON.stringify([...readIds])); } catch {}
}

async function saveHeartIds() {
  try { await storage.set('hids:' + sessionId + ':' + currentJarId, JSON.stringify([...heartIds])); } catch {}
}

async function toggleHeart(id, e) {
  if (e) { e.stopPropagation(); }
  if (heartIds.has(id)) {
    heartIds.delete(id);
    // Decrement shared heart count on letter
    const letter = letters.find(l => l.id === id);
    if (letter) { letter.hearts = Math.max(0, (letter.hearts || 0) - 1); await saveLetters(); }
  } else {
    heartIds.add(id);
    const letter = letters.find(l => l.id === id);
    if (letter) { letter.hearts = (letter.hearts || 0) + 1; await saveLetters(); }
  }
  await saveHeartIds();
  updateHeartUI(id);
}

function updateHeartUI(id) {
  const letter = letters.find(l => l.id === id);
  const count = letter ? (letter.hearts || 0) : 0;
  const hearted = heartIds.has(id);
  // Update all card heart buttons
  document.querySelectorAll(`.heart-btn[data-id="${id}"]`).forEach(btn => {
    btn.classList.toggle('hearted', hearted);
    const countEl = btn.querySelector('.heart-count');
    if (countEl) countEl.textContent = count > 0 ? count : '';
    btn.querySelector('svg path').setAttribute('fill', hearted ? '#e05060' : 'none');
  });
  // Update read modal heart
  const readBtn = document.getElementById('readHeartBtn');
  if (readBtn && currentReadId === id) {
    readBtn.classList.toggle('hearted', hearted);
    const countEl = readBtn.querySelector('.read-heart-count');
    if (countEl) countEl.textContent = count > 0 ? count : '';
    readBtn.querySelector('svg path').setAttribute('fill', hearted ? '#e05060' : 'none');
  }
}

// startPolling is defined below near the storage layer

// ═══════════════════════════════════════════
//  RENDER
// ═══════════════════════════════════════════
function renderAll(animate) {
  // Clear jar
  const jar = document.getElementById('jarLetters');
  jar.innerHTML = letters.length === 0
    ? '<div class="empty-hint" id="emptyHint">no letters yet…<br>be the first</div>'
    : '';

  // Clear panels
  document.getElementById('paneAll').innerHTML = '';
  document.getElementById('paneUnread').innerHTML = '';

  letters.forEach(l => {
    addSlipToJar(l, animate === true);
    addCardToPanel(l, false);
  });

  renderReadJar();
  updateStats();
  updateNoUnreadHint();
}

function addSlipToJar(letter, animate) {
  const container = document.getElementById('jarLetters');
  const hint = document.getElementById('emptyHint');
  if (hint) hint.remove();

  const slip = document.createElement('div');
  slip.className = 'letter-slip' + (isRead(letter.id) ? ' is-read dropped' : '');
  slip.id = 'slip-' + letter.id;
  const r = seededRand(letter.id) * 28 - 14;
  slip.style.setProperty('--r', r.toFixed(1));
  if (!animate) { slip.style.animation = 'none'; slip.style.opacity = isRead(letter.id) ? '0.4' : '1'; }

  const c = letter.color || '#c8192a';
  // Envelope SVG with designated color - solid fill
  slip.innerHTML = `<svg viewBox="0 0 68 48" xmlns="http://www.w3.org/2000/svg">
    <rect x="1" y="1" width="66" height="46" rx="3" fill="${c}cc" stroke="${c}" stroke-width="1.5"/>
    <path d="M1,1 L34,26 L67,1" fill="none" stroke="rgba(0,0,0,0.25)" stroke-width="1.2" stroke-linejoin="round"/>
    <path d="M1,47 L24,28" fill="none" stroke="rgba(0,0,0,0.18)" stroke-width="0.9"/>
    <path d="M67,47 L44,28" fill="none" stroke="rgba(0,0,0,0.18)" stroke-width="0.9"/>
  </svg>`;

  if (!isRead(letter.id)) {
    const dot = document.createElement('div');
    dot.className = 'unread-dot'; dot.id = 'dot-' + letter.id;
    slip.appendChild(dot);
  }
  slip.addEventListener('click', () => openRead(letter.id));
  container.appendChild(slip);

  // Keep badge in sync with jar contents
  const badge = document.getElementById('letterBadge');
  if (badge) badge.textContent = container.querySelectorAll('.letter-slip').length;
}

function addCardToPanel(letter, prepend) {
  const allPane = document.getElementById('paneAll');
  const unreadPane = document.getElementById('paneUnread');
  const h = document.getElementById('noLettersHint');
  if (h) h.remove();

  const card = makeCard(letter);
  if (prepend) allPane.insertBefore(card, allPane.firstChild);
  else allPane.appendChild(card);

  if (!isRead(letter.id)) {
    const uc = makeCard(letter);
    if (prepend) unreadPane.insertBefore(uc, unreadPane.firstChild);
    else unreadPane.appendChild(uc);
  }
}

function makeCard(letter) {
  const card = document.createElement('div');
  card.className = 'recent-card' + (isRead(letter.id) ? ' card-read' : '');
  card.id = 'card-' + letter.id;
  card.style.setProperty('--env-color', letter.color || '#c8192a');
  const dotHtml = !isRead(letter.id)
    ? `<span class="card-unread-dot" id="cdot-${letter.id}"></span>` : '';
  const hearted = heartIds.has(letter.id);
  const heartFill = hearted ? '#e05060' : 'none';
  const heartCount = letter.hearts > 0 ? letter.hearts : '';
  card.innerHTML = `
    <div class="recent-from">${dotHtml}— ${escHtml(letter.from)}</div>
    <button class="heart-btn${hearted ? ' hearted' : ''}" data-id="${letter.id}" onclick="toggleHeart('${letter.id}', event)" title="Heart this letter">
      <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M8 13.5s-6-3.8-6-8a4 4 0 0 1 6-3.46A4 4 0 0 1 14 5.5c0 4.2-6 8-6 8z" fill="${heartFill}" stroke="#e05060" stroke-width="1.3" stroke-linejoin="round"/>
      </svg>
      <span class="heart-count">${heartCount}</span>
    </button>`;
  card.addEventListener('click', () => openRead(letter.id));
  return card;
}

function renderReadJar() {
  const rjContainer = document.getElementById('rjLetters');
  rjContainer.innerHTML = '';
  const readLetters = letters.filter(l => isRead(l.id));
  const section = document.getElementById('readJarSection');
  if (readLetters.length > 0) {
    section.classList.add('visible');
    document.getElementById('readBadge').textContent = readLetters.length;
    readLetters.forEach(l => {
      const slip = document.createElement('div');
      slip.className = 'rj-slip';
      const r = seededRand(l.id + 'r') * 20 - 10;
      slip.style.setProperty('--r', r.toFixed(1));
      slip.style.borderLeftColor = l.color || '#c8192a';
      const words = (l.body || '').split(' ');
      slip.textContent = words.slice(0, 2).join(' ') + (words.length > 2 ? '…' : '');
      rjContainer.appendChild(slip);
    });
  } else {
    section.classList.remove('visible');
  }
}

function updateStats() {
  const n = letters.length;
  const unc = letters.filter(l => !isRead(l.id)).length;
  const badge = document.getElementById('letterBadge');
  // Fallback: count slips in jar DOM in case letters array is momentarily stale
  const domCount = document.querySelectorAll('#jarLetters .letter-slip').length;
  badge.textContent = Math.max(n, domCount);
  ['unreadBadge','unreadBadge2'].forEach(id => {
    const el = document.getElementById(id);
    el.textContent = unc;
    el.classList.toggle('hidden', unc === 0);
  });
  updateJarContext();
}

function updateJarContext() {
  const jar = jars.find(j => j.id === currentJarId);
  if (!jar) return;
  document.getElementById('jarContextName').textContent = jar.name;
  const unc = letters.filter(l => !isRead(l.id)).length;
  document.getElementById('jarContextCount').textContent =
    letters.length === 0 ? 'empty — write the first letter'
    : `${letters.length} letter${letters.length !== 1 ? 's' : ''}${unc > 0 ? `, ${unc} unread` : ''}`;
  document.getElementById('jarNameDisplay').textContent = jar.name;
  document.getElementById('panelTitle').textContent = jar.name;
}

function updateNoUnreadHint() {
  const pane = document.getElementById('paneUnread');
  const cards = pane.querySelectorAll('.recent-card');
  const hint = document.getElementById('noUnreadHint');
  if (cards.length === 0) {
    if (!hint) { const p = document.createElement('p'); p.className = 'no-letters-hint'; p.id = 'noUnreadHint'; p.innerHTML = "You've read everything<br>in the jar ✦"; pane.appendChild(p); }
    else hint.style.display = '';
  } else if (hint) hint.style.display = 'none';
}

// ═══════════════════════════════════════════
//  JAR DROPDOWN
// ═══════════════════════════════════════════
function renderJarDropdown() {
  const list = document.getElementById('jarDropdownList');
  list.innerHTML = '';
  jars.forEach(jar => {
    const count = getJarLetterCount(jar.id); // cached or 0
    const opt = document.createElement('div');
    opt.className = 'jar-option' + (jar.id === currentJarId ? ' active-jar' : '');
    opt.innerHTML = `<span class="jar-opt-name">${escHtml(jar.name)}</span><span class="jar-opt-count">${count} letter${count !== 1 ? 's' : ''}</span>`;
    if (jars.length > 1) {
      const del = document.createElement('button');
      del.className = 'jar-opt-del'; del.textContent = '✕'; del.title = 'Delete jar';
      del.addEventListener('click', e => { e.stopPropagation(); openDeleteJar(jar.id); });
      opt.appendChild(del);
    }
    opt.addEventListener('click', async () => {
      closeJarDropdown();
      if (jar.id !== currentJarId) await switchToJar(jar.id, true);
    });
    list.appendChild(opt);
  });
  document.getElementById('jarNameDisplay').textContent = jars.find(j => j.id === currentJarId)?.name || '—';
}

// Cache letter counts so dropdown doesn't lag
const jarCountCache = {};
function getJarLetterCount(jarId) {
  if (jarId === currentJarId) { jarCountCache[jarId] = letters.length; return letters.length; }
  return jarCountCache[jarId] || 0;
}

// Load letter counts for other jars in background
async function loadOtherJarCounts() {
  for (const jar of jars) {
    if (jar.id === currentJarId) continue;
    try {
      const r = await storage.get('letters:' + jar.id, true);
      jarCountCache[jar.id] = r ? JSON.parse(r.value).length : 0;
    } catch {}
  }
  renderJarDropdown();
}

function toggleJarDropdown(e) {
  e.stopPropagation();
  const wrap = document.getElementById('jarSelectorWrap');
  const isOpen = wrap.classList.contains('open');
  wrap.classList.toggle('open');
  if (!isOpen) { loadOtherJarCounts(); }
}

function closeJarDropdown() {
  document.getElementById('jarSelectorWrap').classList.remove('open');
}

document.addEventListener('click', e => {
  if (!document.getElementById('jarSelectorWrap').contains(e.target)) closeJarDropdown();
});

// ═══════════════════════════════════════════
//  CREATE JAR
// ═══════════════════════════════════════════
function openCreateJar() {
  closeJarDropdown();
  document.getElementById('createJarOverlay').classList.add('open');
  setTimeout(() => document.getElementById('jarNameInput').focus(), 300);
}
function closeCreateJar() {
  document.getElementById('createJarOverlay').classList.remove('open');
  document.getElementById('jarNameInput').value = '';
  document.getElementById('jarDescInput').value = '';
}
function handleCreateJarClick(e) { if (e.target === document.getElementById('createJarOverlay')) closeCreateJar(); }

async function createJar() {
  const name = document.getElementById('jarNameInput').value.trim();
  if (!name) {
    document.getElementById('jarNameInput').style.borderColor = 'rgba(200,25,42,0.8)';
    setTimeout(() => document.getElementById('jarNameInput').style.borderColor = '', 800);
    return;
  }
  const desc = document.getElementById('jarDescInput').value.trim();
  const jar = { id: genId('jar'), name, desc, createdAt: Date.now() };
  jars.push(jar);
  await saveJarsList();
  closeCreateJar();
  await switchToJar(jar.id, true);
  showToast(`"${name}" is ready ✦`);
}

// ═══════════════════════════════════════════
//  DELETE JAR
// ═══════════════════════════════════════════
function openDeleteJar(jarId) {
  pendingDeleteJarId = jarId;
  const jar = jars.find(j => j.id === jarId);
  document.getElementById('deleteJarNameDisplay').textContent = jar?.name || 'this jar';
  // Show approximate count
  const cnt = jarId === currentJarId ? letters.length : (jarCountCache[jarId] || '?');
  document.getElementById('deleteJarCountDisplay').textContent = cnt;
  document.getElementById('deleteJarOverlay').classList.add('open');
}
function closeDeleteJar() { document.getElementById('deleteJarOverlay').classList.remove('open'); pendingDeleteJarId = null; }
function handleDeleteJarClick(e) { if (e.target === document.getElementById('deleteJarOverlay')) closeDeleteJar(); }

async function confirmDeleteJar() {
  if (!pendingDeleteJarId) return;
  const id = pendingDeleteJarId;
  // Remove from list
  jars = jars.filter(j => j.id !== id);
  await saveJarsList();
  // Delete letters
  try { await storage.delete('letters:' + id, true); } catch {}
  closeDeleteJar();

  if (jars.length === 0) await createDefaultJar();
  const nextId = id === currentJarId ? jars[0].id : currentJarId;
  await switchToJar(nextId, true);
  showToast('Jar deleted');
}

// ═══════════════════════════════════════════
//  WRITE + SUBMIT
// ═══════════════════════════════════════════
function openModal() {
  document.getElementById('overlay').classList.add('open');
  setTimeout(() => document.getElementById('fromField').focus(), 350);
}
function closeModal() {
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('fromField').value = '';
  document.getElementById('letterBody').value = '';
}
function handleOverlayClick(e) { if (e.target === document.getElementById('overlay')) closeModal(); }

async function submitLetter() {
  const from = document.getElementById('fromField').value.trim() || 'Anonymous';
  const body = document.getElementById('letterBody').value.trim();
  if (!body) {
    const ta = document.getElementById('letterBody');
    ta.style.borderColor = 'rgba(200,25,42,0.8)';
    ta.focus();
    setTimeout(() => ta.style.borderColor = '', 900);
    return;
  }
  const letter = { id: genId('ltr'), from, body, color: selectedColor, ts: Date.now() };
  letters.push(letter);
  await saveLetters();

  const hint = document.getElementById('emptyHint');
  if (hint) hint.remove();
  addSlipToJar(letter, true);
  addCardToPanel(letter, true);
  updateStats();
  closeModal();
  showToast('Your letter found its place ✦');
  bumpBadge();
}

function bumpBadge() {
  const b = document.getElementById('letterBadge');
  b.classList.add('bump');
  setTimeout(() => b.classList.remove('bump'), 400);
}

function selectColor(el) {
  document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
  selectedColor = el.dataset.color;
}

// ═══════════════════════════════════════════
//  READ
// ═══════════════════════════════════════════
let currentReadId = null;

function openRead(id) {
  currentReadId = id;
  const letter = letters.find(l => l.id === id);
  if (!letter) return;
  document.getElementById('readFrom').textContent = '— from ' + letter.from;
  document.getElementById('readBody').textContent = letter.body;
  document.getElementById('readEnvStripe').style.background = letter.color || '#c8192a';
  document.getElementById('readWax').querySelector('circle').setAttribute('fill', (letter.color || '#c8192a') + '80');
  // Heart button state
  const hearted = heartIds.has(id);
  const readHeartBtn = document.getElementById('readHeartBtn');
  readHeartBtn.classList.toggle('hearted', hearted);
  readHeartBtn.querySelector('svg path').setAttribute('fill', hearted ? '#e05060' : 'none');
  document.getElementById('readHeartCount').textContent = letter.hearts > 0 ? letter.hearts : '';
  document.getElementById('readOverlay').classList.add('open');
  if (!isRead(id)) markRead(id);
}

async function markRead(id) {
  readIds.add(id);
  await saveReadIds();

  const slip = document.getElementById('slip-' + id);
  if (slip) {
    slip.classList.add('is-read', 'dropped');
    const dot = document.getElementById('dot-' + id);
    if (dot) { dot.style.transition='opacity 0.4s'; dot.style.opacity='0'; setTimeout(()=>dot.remove(),400); }
  }
  document.querySelectorAll('#card-' + id).forEach(card => {
    card.classList.add('card-read');
    const cdot = card.querySelector('.card-unread-dot');
    if (cdot) { cdot.style.transition='opacity 0.4s'; cdot.style.opacity='0'; setTimeout(()=>cdot.remove(),400); }
  });
  // Remove from unread pane
  document.querySelectorAll('#paneUnread #card-' + id).forEach(c => {
    c.style.transition='opacity 0.4s, transform 0.4s'; c.style.opacity='0'; c.style.transform='translateX(8px)';
    setTimeout(()=>c.remove(), 420);
  });
  setTimeout(() => { renderReadJar(); updateStats(); updateNoUnreadHint(); }, 460);
}

function closeRead() { 
  document.getElementById('readOverlay').classList.remove('open'); 
  cancelDeleteLetter();
  currentReadId = null;
}
function handleReadClick(e) { if (e.target === document.getElementById('readOverlay')) closeRead(); }

function promptDeleteLetter() {
  document.getElementById('readDeleteConfirm').classList.add('visible');
}

function cancelDeleteLetter() {
  const el = document.getElementById('readDeleteConfirm');
  if (el) el.classList.remove('visible');
}

async function confirmDeleteLetter() {
  if (!currentReadId) return;
  const id = currentReadId;
  letters = letters.filter(l => l.id !== id);
  readIds.delete(id);
  await saveLetters();
  await saveReadIds();
  closeRead();
  const slip = document.getElementById('slip-' + id);
  if (slip) slip.remove();
  document.querySelectorAll('#card-' + id).forEach(c => c.remove());
  updateStats();
  updateNoUnreadHint();
  renderReadJar();
  if (letters.length === 0) {
    const jar = document.getElementById('jarLetters');
    jar.innerHTML = '<div class="empty-hint" id="emptyHint">no letters yet…<br>be the first</div>';
  }
  showToast('Letter removed from the jar');
}

// ═══════════════════════════════════════════
//  READ JAR MODAL
// ═══════════════════════════════════════════
function openReadJarModal() {
  const list = document.getElementById('rjModalList');
  list.innerHTML = '';
  const readLetters = letters.filter(l => isRead(l.id)).slice().reverse();
  if (!readLetters.length) { list.innerHTML = '<p class="rj-empty">Nothing read yet…</p>'; }
  else readLetters.forEach(l => {
    const item = document.createElement('div');
    item.className = 'rj-list-item'; item.style.setProperty('--env-color', l.color || '#c8192a');
    item.innerHTML = `<div class="rj-item-from">— ${escHtml(l.from)}</div><div class="rj-item-preview">${escHtml(l.body)}</div>`;
    item.addEventListener('click', () => { closeRjModal(); setTimeout(() => openRead(l.id), 200); });
    list.appendChild(item);
  });
  document.getElementById('rjOverlay').classList.add('open');
}
function closeRjModal() { document.getElementById('rjOverlay').classList.remove('open'); }
function handleRjClick(e) { if (e.target === document.getElementById('rjOverlay')) closeRjModal(); }

// ═══════════════════════════════════════════
//  TABS
// ═══════════════════════════════════════════
function switchTab(tab) {
  document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.getElementById('tab' + tab).classList.add('active');
  document.getElementById('pane' + tab).classList.add('active');
}

// ═══════════════════════════════════════════
//  UTILS
// ═══════════════════════════════════════════
function isRead(id) { return readIds.has(id); }
function genId(prefix) { return prefix + '-' + Math.random().toString(36).slice(2,9) + Date.now().toString(36); }
function seededRand(str) { let h=0; for(let i=0;i<str.length;i++) h=(Math.imul(31,h)+str.charCodeAt(i))|0; return (h>>>0)/0xFFFFFFFF; }
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
function scrollJar() { document.querySelector('.jar-scene').scrollIntoView({behavior:'smooth',block:'center'}); }

// ═══════════════════════════════════════════
//  STORAGE — Firebase Realtime Database
//  Shared across all users everywhere.
//  Personal keys (shared=false) → localStorage
//  Shared keys  (shared=true)  → Firebase
// ═══════════════════════════════════════════

// ┌──────────────────────────────────────────────────────────────┐
// │  PASTE YOUR FIREBASE CONFIG VALUES BELOW                     │
// │  Get them from: Firebase Console → Project Settings →        │
// │  "Your apps" → SDK setup → Config                            │
// └──────────────────────────────────────────────────────────────┘
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyCmGaCnMCvHG1LKdWaUuJ6gId9BOrdmRUk",
  authDomain:        "letters-f617f.firebaseapp.com",
  databaseURL:       "https://letters-f617f-default-rtdb.firebaseio.com",
  projectId:         "letters-f617f",
  storageBucket:     "letters-f617f.firebasestorage.app",
  messagingSenderId: "885169278039",
  appId:             "1:885169278039:web:33c14259374faa7b1d2712"
};
// ───────────────────────────────────────────────────────────────

const LOCAL_PREFIX = 'lj_local:';
const _fbReady = FIREBASE_CONFIG.databaseURL && !FIREBASE_CONFIG.databaseURL.includes('PASTE');

// Firebase REST base URL  (no SDK needed — just fetch)
const _fbBase = _fbReady ? FIREBASE_CONFIG.databaseURL.replace(/\/$/, '') : null;
const _fbKey  = _fbReady ? FIREBASE_CONFIG.apiKey : null;

// Encode keys: Firebase paths can't have . $ # [ ] /
function _enc(key) { return key.replace(/[^a-zA-Z0-9_-]/g, c => '_' + c.charCodeAt(0) + '_'); }

const storage = window.storage || {
  get: async (key, shared) => {
    if (!shared) {
      const val = localStorage.getItem(LOCAL_PREFIX + key);
      return val !== null ? { key, value: val } : null;
    }
    if (!_fbReady) return null;
    try {
      const res = await fetch(`${_fbBase}/lj/${_enc(key)}.json`);
      if (!res.ok) return null;
      const data = await res.json();
      if (data === null) return null;
      return { key, value: typeof data === 'string' ? data : JSON.stringify(data), shared: true };
    } catch { return null; }
  },
  set: async (key, value, shared) => {
    if (!shared) { localStorage.setItem(LOCAL_PREFIX + key, value); return { key, value }; }
    if (!_fbReady) return null;
    try {
      const res = await fetch(`${_fbBase}/lj/${_enc(key)}.json`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(value)
      });
      return res.ok ? { key, value, shared: true } : null;
    } catch { return null; }
  },
  delete: async (key, shared) => {
    if (!shared) { localStorage.removeItem(LOCAL_PREFIX + key); return { key, deleted: true }; }
    if (!_fbReady) return null;
    try {
      await fetch(`${_fbBase}/lj/${_enc(key)}.json`, { method: 'DELETE' });
      return { key, deleted: true, shared: true };
    } catch { return null; }
  }
};

function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const r = await storage.get('letters:' + currentJarId, true);
      const loaded = r ? JSON.parse(r.value) : [];
      const existingIds = new Set(letters.map(l => l.id));
      const loadedIds   = new Set(loaded.map(l => l.id));
      const hasChanges  = loaded.length !== letters.length || loaded.some(l => !existingIds.has(l.id));
      if (hasChanges) {
        const prevIds = new Set(letters.map(l => l.id));
        letters = loaded;
        for (const l of loaded) {
          if (!prevIds.has(l.id)) {
            const hint = document.getElementById('emptyHint');
            if (hint) hint.remove();
            addSlipToJar(l, true);
            addCardToPanel(l, true);
          }
        }
        for (const id of prevIds) {
          if (!loadedIds.has(id)) {
            const slip = document.getElementById('slip-' + id);
            if (slip) slip.remove();
            document.querySelectorAll('#card-' + id).forEach(c => c.remove());
          }
        }
        if (letters.length === 0) {
          document.getElementById('jarLetters').innerHTML =
            '<div class="empty-hint" id="emptyHint">no letters yet…<br>be the first</div>';
        }
        updateStats(); updateNoUnreadHint(); renderReadJar(); renderJarDropdown();
      }
      const jr = await storage.get('jars', true);
      const loadedJars = jr ? JSON.parse(jr.value) : [];
      const jarChanged = loadedJars.length !== jars.length || loadedJars.some(j => !jars.find(x => x.id === j.id));
      if (jarChanged) {
        jars = loadedJars; renderJarDropdown(); updateJarContext();
        if (!jars.find(j => j.id === currentJarId) && jars.length > 0) await switchToJar(jars[0].id, false);
      }
    } catch {}
  }, 5000);
}

// Status banner
(function() {
  const banner = document.getElementById('sharedBanner');
  banner.className = 'shared-banner ' + (_fbReady ? 'live' : 'local');
  banner.innerHTML = _fbReady
    ? '<span class="shared-dot"></span>Live · shared with everyone'
    : '<span class="shared-dot"></span>Setup needed · paste your Firebase config';
  setTimeout(() => { banner.style.opacity = '1'; }, 900);
})();

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeRead(); closeRjModal(); closeCreateJar(); closeDeleteJar(); closeJarDropdown(); }
});

init().then(() => {
  // Re-sync badge after Firebase may have finished loading
  setTimeout(() => { if (typeof updateStats === 'function') updateStats(); }, 1500);
});
</script>
</body>
</html>
